<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magnatesting - Panel de Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <style>
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --radius: 0.375rem;
            --radius-lg: 0.5rem;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }

        /* Small text utility for subtle status messages */
        .text-small {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Compact toasts */
        .toast {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            box-shadow: var(--shadow);
            min-width: 200px;
            max-width: 360px;
            font-size: 0.85rem;
        }

        .toast .toast-title {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .toast .toast-message {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .toast .toast-icon {
            font-size: 1.1rem;
            margin-top: 2px;
        }

        /* Extra compact variant for brief status messages */
        .toast.compact {
            padding: 0.25rem 0.5rem;
            min-width: 140px;
            max-width: 300px;
            font-size: 0.72rem;
        }

        .toast.compact .toast-title {
            font-size: 0.75rem;
        }

        .toast.compact .toast-message {
            font-size: 0.68rem;
        }



        [data-theme="dark"] {
            --bg-primary: var(--gray-900);
            --bg-secondary: var(--gray-800);
            --bg-tertiary: var(--gray-700);
            --text-primary: var(--gray-50);
            --text-secondary: var(--gray-200);
            --text-muted: var(--gray-400);
            --border-color: var(--gray-700);
            --hover-color: var(--gray-700);
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: var(--gray-50);
            --bg-tertiary: var(--gray-100);
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-700);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);
            --hover-color: var(--gray-100);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            transition: var(--transition);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .logo-icon {
            margin-right: 0.75rem;
            color: var(--primary-500);
            font-size: 1.5rem;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1.5rem 1rem;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            padding: 0 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background-color: var(--hover-color);
            color: var(--text-primary);
        }

        .nav-item.active {
            background-color: var(--primary-50);
            color: var(--primary-600);
        }

        [data-theme="dark"] .nav-item.active {
            background-color: var(--primary-700);
            color: white;
        }

        .nav-icon {
            margin-right: 0.75rem;
            width: 1.25rem;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .theme-switcher {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-switcher:hover {
            background-color: var(--hover-color);
        }

        .theme-icon {
            margin-right: 0.75rem;
        }

        .toggle {
            font-size: 1.5rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-primary);
            cursor: pointer;
            margin-right: 1rem;
        }

        .search-container {
            position: relative;
            flex: 1;
            max-width: 400px;
            margin-right: 1.5rem;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .user-menu {
            display: flex;
            align-items: center;
        }

        .notifications {
            position: relative;
            margin-right: 1.5rem;
        }

        .notification-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .notification-btn:hover {
            background-color: var(--hover-color);
        }

        .notification-badge {
            position: absolute;
            top: -0.25rem;
            right: -0.25rem;
            background-color: var(--danger);
            color: white;
            font-size: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-lg);
            transition: var(--transition);
        }

        .user-profile:hover {
            background-color: var(--hover-color);
        }

        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: var(--primary-500);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.75rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .dashboard-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 1.125rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.primary {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary-500);
        }

        .stat-icon.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-icon.warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .stat-icon.danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .trend {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .trend.up {
            color: var(--success);
        }

        .trend.down {
            color: var(--danger);
        }

        .trend i {
            margin-right: 0.25rem;
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .content-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background-color: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            outline: none;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-primary {
            background-color: var(--primary-500);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-600);
        }

        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--hover-color);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: var(--bg-secondary);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .data-table td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .data-table tr:hover td {
            background-color: var(--hover-color);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.accepted {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-badge.pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-badge.rejected {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .activity-item {
            display: flex;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .activity-desc {
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-width: 300px;
            animation: slideIn 0.3s ease;
            transition: var(--transition);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast.info {
            border-left: 4px solid var(--info);
        }

        .toast-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .toast.info .toast-icon {
            color: var(--info);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.875rem;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-muted);
            margin-left: 0.75rem;
            transition: var(--transition);
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loader */
        .loader {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-500);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
            }

            .sidebar.active {
                left: 0;
            }

            .menu-toggle {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para formularios en modales */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        /* Estilos para gráficos */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1.5rem;
        }

        /* Estilos para listas de elementos */
        .list-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .list-item:hover {
            background-color: var(--hover-color);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .list-item-subtitle {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .list-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Filtros */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Detalles */
        .detail-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .detail-item span {
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <i class="fas fa-hard-hat logo-icon"></i>
                    <span>Magnatesting</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <h3 class="nav-title">Principal</h3>
                    <a href="#" class="nav-item active" data-section="dashboard">
                        <i class="fas fa-home nav-icon"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="nav-item" data-section="estadisticas">
                        <i class="fas fa-chart-line nav-icon"></i>
                        <span>Estadísticas</span>
                    </a>
                </div>

                <div class="nav-section">
                    <h3 class="nav-title">Gestión</h3>
                    <a href="#" class="nav-item" data-section="empresas">
                        <i class="fas fa-building nav-icon"></i>
                        <span>Empresas</span>
                    </a>
                    <a href="#" class="nav-item" data-section="herramientas">
                        <i class="fas fa-tools nav-icon"></i>
                        <span>Herramientas</span>
                    </a>
                    <a href="#" class="nav-item" data-section="actividades">
                        <i class="fas fa-list-check nav-icon"></i>
                        <span>Actividades</span>
                    </a>
                    <a href="#" class="nav-item" data-section="inspecciones">
                        <i class="fas fa-clipboard-check nav-icon"></i>
                        <span>Inspecciones</span>
                    </a>
                    <a href="#" class="nav-item" data-section="reportes">
                        <i class="fas fa-file-pdf nav-icon"></i>
                        <span>Reportes</span>
                    </a>
                </div>

                <div class="nav-section">
                    <h3 class="nav-title">Configuración</h3>
                    <a href="#" class="nav-item" data-section="ajustes">
                        <i class="fas fa-cog nav-icon"></i>
                        <span>Ajustes</span>
                    </a>
                    <!-- Usuarios UI removed: access to user list disabled so user records remain only in DB -->
                    <!-- (link intentionally omitted to prevent exposing user list in the UI) -->
                </div>
            </nav>

            <div class="sidebar-footer">
                <div id="theme-switcher" class="theme-switcher">
                    <i class="fas fa-moon theme-icon"></i>
                    <span>Modo oscuro</span>
                </div>
                <div class="toggle">
                    <i class="fas fa-toggle-off"></i>
                </div>
            </div>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content">
            <header class="header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="global-search" placeholder="Buscar...">
                </div>

                <div class="user-menu">
                    <div class="notifications">
                        <button class="notification-btn" id="notifications-btn">
                            <i class="fas fa-bell"></i>
                        </button>
                        <span class="notification-badge">0</span>
                    </div>

                    <div class="user-profile" id="user-profile">
                        <div class="user-avatar" id="user-avatar">A</div>
                        <div class="user-info">
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <div class="user-name" id="user-name">Administrador</div>
                                <div id="user-status"
                                    style="font-size:0.75rem;
                                    padding:0.25rem 0.5rem; border-radius:9999px; background:rgba(0,0,0,0.05); color:var(--text-muted);">
                                    Estado</div>
                            </div>
                            <div class="user-role" id="user-role">Superadmin</div>
                        </div>
                    </div>
                    <!-- Logout button (only in Control de Mando) -->
                    <div style="margin-left:1rem;">
                        <button class="btn btn-secondary btn-sm" id="logout-btn" title="Cerrar sesión">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">
                <!-- Contenido dinámico se cargará aquí -->
                <div id="content-area">
                    <!-- El contenido se cargará dinámicamente según la sección -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para todas las secciones -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Gestión</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modal-cancel">Cancelar</button>
                <button class="btn btn-primary" id="modal-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Logout modal removed per request -->

    <!-- Modal para detalles -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="detail-modal-title">Detalles</h2>
                <button class="modal-close" data-modal-close="detail">&times;</button>
            </div>
            <div class="modal-body" id="detail-modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-modal-close="detail">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Contenedor para notificaciones toast -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // Configuración de la API: determine base dinámicamente desde la URL
        // This finds the path prefix before '/frontend' (if present) so API calls target e.g. https://host/<project>/api
        const API_BASE_URL = (() => {
            try {
                const origin = window.location.origin; // e.g. http://localhost
                const path = window.location.pathname; // e.g. /FERDATA/frontend/MODULO_CONTROL_DE_MANDO.html
                const marker = '/frontend';
                const idx = path.indexOf(marker);
                const basePath = idx !== -1 ? path.slice(0, idx) : path.replace(/\/[^\/]*$/, '');
                // ensure no trailing slash
                const normalized = basePath.endsWith('/') ? basePath.slice(0, -1) : basePath;
                return origin + normalized + '/api';
            } catch (e) {
                // fallback to a relative path
                return '/api';
            }
        })();

        // Fallback to Apache/PHP location (XAMPP). Assumes project folder is served at http://localhost/FERDATA
        const APACHE_API_BASE = window.location.protocol + '//' + window.location.hostname + '/FERDATA/api';

        // Estado de la aplicación
        const state = {
            currentModal: null,
            currentSection: 'dashboard',
            theme: localStorage.getItem('theme') || 'light',
            user: null,
            data: {
                empresas: [],
                herramientas: [],
                inspecciones: [],
                actividades: [],
                usuarios: [],
                estadisticas: {}
            },
            filters: {
                search: '',
                status: 'all'
            }
        };

        // Elementos del DOM
        const elements = {
            sidebar: document.getElementById('sidebar'),
            menuToggle: document.getElementById('menu-toggle'),
            themeSwitcher: document.getElementById('theme-switcher'),
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            userRole: document.getElementById('user-role'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalClose: document.getElementById('modal-close'),
            modalCancel: document.getElementById('modal-cancel'),
            modalConfirm: document.getElementById('modal-confirm'),
            // logout UI removed
            toastContainer: document.getElementById('toast-container'),
            contentArea: document.getElementById('content-area'),
            globalSearch: document.getElementById('global-search')
        };

        // Inicializar la aplicación
        async function initApp() {
            console.log('initApp start');
            await checkAuth();
            setupEventListeners();
            // Apply theme early to avoid flash
            applyTheme();
            await loadDashboardContent();
        }

        // Verificar autenticación
        async function checkAuth() {
            const token = localStorage.getItem('token');

            // No token -> redirect to login
            if (!token) {
                window.location.href = 'MODULO_INICIO_DE_SESION.html';
                return;
            }

            // Parse user from localStorage safely
            let user = null;
            try {
                const raw = localStorage.getItem('user');
                user = raw ? JSON.parse(raw) : null;
            } catch (err) {
                console.error('Error parsing stored user:', err);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'MODULO_INICIO_DE_SESION.html';
                return;
            }

            if (!user) {
                localStorage.removeItem('token');
                window.location.href = 'MODULO_INICIO_DE_SESION.html';
                return;
            }

            // Normalize name fields
            if (!user.nombre && user.nombre_completo) user.nombre = user.nombre_completo;

            // Verify token with server; if verification fails, redirect to login
            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Token inválido');

                state.user = user;
                // fetch fresh user record to get latest 'activo' flag
                try {
                    const fresh = await apiGet(`/usuarios/${user.id || user.ID || user.Id}`);
                    if (fresh && typeof fresh === 'object') {
                        // merge values but avoid overwriting local values with null/undefined from the DB
                        const merged = Object.assign({}, user);
                        for (const [k, v] of Object.entries(fresh)) {
                            if (typeof v !== 'undefined' && v !== null) merged[k] = v;
                        }
                        user = merged;
                        state.user = user;
                    }
                } catch (e) {
                    console.warn('Could not fetch fresh user record:', e);
                }
                updateUserInfo();
                console.log('Autenticación verificada, usuario cargado:', state.user);
            } catch (error) {
                console.error('Error de autenticación:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                setTimeout(() => { window.location.href = 'MODULO_INICIO_DE_SESION.html'; }, 300);
            }
        }

        // Actualizar información del usuario
        function updateUserInfo() {
            if (state.user) {
                if (elements.userAvatar) elements.userAvatar.textContent = state.user.nombre ? state.user.nombre.charAt(0).toUpperCase() : 'U';
                if (elements.userName) elements.userName.textContent = state.user.nombre || 'Usuario';
                if (elements.userRole) elements.userRole.textContent = state.user.rol || 'Usuario';
                // update status badge
                const statusEl = document.getElementById('user-status');
                if (statusEl) {
                    let activo = (typeof state.user.activo !== 'undefined') ? state.user.activo : null;
                    // If backend returned null for 'activo' but we have a token and this is the logged-in user,
                    // infer active = true (user is currently using the app).
                    const token = localStorage.getItem('token');
                    try {
                        const storedRaw = localStorage.getItem('user');
                        const stored = storedRaw ? JSON.parse(storedRaw) : null;
                        const storedId = stored ? (stored.id || stored.ID || stored.Id) : null;
                        const sessionId = state.user ? (state.user.id || state.user.ID || state.user.Id) : null;
                        if ((activo === null || typeof activo === 'undefined') && token && storedId && sessionId && String(storedId) === String(sessionId)) {
                            activo = 1; // infer active
                        }
                    } catch (e) { /* ignore parse errors */ }

                    if (activo === 1 || activo === '1' || activo === true || activo === 'true') {
                        statusEl.textContent = 'Activo';
                        statusEl.style.background = 'rgba(16,185,129,0.12)';
                        statusEl.style.color = 'var(--success)';
                    } else if (activo === 0 || activo === '0' || activo === false || activo === 'false') {
                        statusEl.textContent = 'Inactivo';
                        statusEl.style.background = 'rgba(239,68,68,0.08)';
                        statusEl.style.color = 'var(--danger)';
                    } else {
                        statusEl.textContent = 'Estado desconocido';
                        statusEl.style.background = 'rgba(0,0,0,0.04)';
                        statusEl.style.color = 'var(--text-muted)';
                    }
                }
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Menu toggle para móviles
            if (elements.menuToggle) elements.menuToggle.addEventListener('click', toggleSidebar);

            // Aplicar tema inicial en el documento
            document.documentElement.setAttribute('data-theme', state.theme || 'light');

            // Bind theme switcher
            if (elements.themeSwitcher) {
                elements.themeSwitcher.addEventListener('click', toggleTheme);
            }

            // Navegación: delegación en el sidebar + fallback por ítem
            try {
                if (elements.sidebar) {
                    console.log('setupEventListeners: sidebar found, attaching delegated click listener');
                    elements.sidebar.addEventListener('click', (e) => {
                        const navItem = e.target.closest('[data-section]');
                        if (!navItem) return;
                        e.preventDefault();
                        const section = navItem.dataset.section;
                        console.log('sidebar navigation click ->', section);
                        // Update active class immediately for feedback
                        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                        navItem.classList.add('active');
                        // Show a loading placeholder while the section loads
                        if (elements.contentArea) {
                            elements.contentArea.innerHTML = `
                                <div style="padding:2rem; text-align:center;">
                                    <div class="loader" style="margin:0 auto;"></div>
                                        <p class="text-small">Cargando sección...</p>
                                </div>
                            `;
                        }
                        loadSection(section).catch(err => {
                            console.error('Error loading section (delegated):', err);
                        });
                    });

                    // Fallback: attach individual listeners in case delegation is blocked
                    const navItems = elements.sidebar.querySelectorAll('.nav-item[data-section]');
                    if (navItems && navItems.length > 0) {
                        console.log('setupEventListeners: attaching per-item fallback listeners (count=', navItems.length, ')');
                        navItems.forEach(item => {
                            item.addEventListener('click', (ev) => {
                                ev.preventDefault();
                                const section = item.dataset.section;
                                console.log('nav-item click fallback ->', section);
                                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                                item.classList.add('active');
                                if (elements.contentArea) {
                                    elements.contentArea.innerHTML = `
                                        <div style="padding:2rem; text-align:center;">
                                            <div class="loader" style="margin:0 auto;"></div>
                                            <p class="text-small">Cargando sección...</p>
                                        </div>
                                    `;
                                }
                                loadSection(section).catch(err => console.error('Error loading section (fallback):', err));
                            });
                        });
                    }
                } else {
                    console.warn('setupEventListeners: sidebar element not found');
                }
            } catch (err) {
                console.error('setupEventListeners error', err);
            }
        }
        // Logout UI removed
        // Modales
        document.querySelectorAll('[data-modal]').forEach(element => {
            element.addEventListener('click', () => openModal(element.dataset.modal));
        });

        // Main modal buttons
        if (elements.modalClose) elements.modalClose.addEventListener('click', closeModal);
        if (elements.modalCancel) elements.modalCancel.addEventListener('click', closeModal);
        if (elements.modalOverlay) elements.modalOverlay.addEventListener('click', (e) => { if (e.target === elements.modalOverlay) closeModal(); });

        // Detail modal close buttons (buttons use data-modal-close="detail")
        document.querySelectorAll('[data-modal-close]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = btn.dataset.modalClose || null;
                // if attribute present and equals 'detail', close detail modal; otherwise call generic close
                if (target) closeModal(target);
                else closeModal();
            });
        });

        // Close detail modal when clicking the overlay area
        const detailModalEl = document.getElementById('detail-modal');
        if (detailModalEl) detailModalEl.addEventListener('click', (e) => { if (e.target === detailModalEl) closeModal('detail'); });

        // Cerrar modales con Escape key (global)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeModal('detail');
            }
        });

        // Alternar sidebar en móviles
        function toggleSidebar() {
            elements.sidebar.classList.toggle('active');
        }

        // Attach logout behavior for control panel logout button
        try {
            const cpLogoutBtn = document.getElementById('logout-btn');
            if (cpLogoutBtn) {
                cpLogoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    try { localStorage.removeItem('token'); localStorage.removeItem('user'); } catch (err) { console.warn('Error clearing storage on logout', err); }
                    // redirect to main module login page
                    window.location.href = 'MODULO_PRINCIPAL.html';
                });
            }
        } catch (err) {
            console.warn('Failed to attach control panel logout', err);
        }

        // Alternar tema claro/oscuro
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            localStorage.setItem('theme', state.theme);
        }

        // Aplicar el tema actual
        function applyTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);

            console.log('applyTheme ->', state.theme);

            try {
                if (elements.themeSwitcher) {
                    const themeIcon = elements.themeSwitcher.querySelector('.fa-toggle-off, .fa-toggle-on');
                    const label = elements.themeSwitcher.querySelector('span');
                    if (themeIcon) {
                        if (state.theme === 'dark') {
                            themeIcon.classList.remove('fa-toggle-off');
                            themeIcon.classList.add('fa-toggle-on');
                        } else {
                            themeIcon.classList.remove('fa-toggle-on');
                            themeIcon.classList.add('fa-toggle-off');
                        }
                    }
                    if (label) {
                        label.textContent = state.theme === 'dark' ? 'Modo claro' : 'Modo oscuro';
                    }
                }

                // Also update any small .toggle icon element inside footer
                const smallToggle = document.querySelector('.sidebar-footer .toggle i');
                if (smallToggle) {
                    if (state.theme === 'dark') {
                        smallToggle.classList.remove('fa-toggle-off');
                        smallToggle.classList.add('fa-toggle-on');
                    } else {
                        smallToggle.classList.remove('fa-toggle-on');
                        smallToggle.classList.add('fa-toggle-off');
                    }
                }
            } catch (err) {
                console.warn('applyTheme error', err);
            }
        }

        // Cargar sección específica
        async function loadSection(section) {
            state.currentSection = section;

            // Actualizar navegación
            try {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                const activeEl = document.querySelector(`[data-section="${section}"]`);
                if (activeEl) activeEl.classList.add('active');
            } catch (err) {
                console.warn('Error updating nav active class', err);
            }

            // Cargar contenido específico
            try {
                // quick visual feedback if contentArea is present
                if (elements.contentArea) {
                    elements.contentArea.innerHTML = `
                        <div style="padding:1.5rem; text-align:center;">
                            <div class="loader"></div>
                            <p class="text-small">Cargando sección: ${section}...</p>
                        </div>
                    `;
                }
                switch (section) {
                    case 'dashboard':
                        await loadDashboardContent();
                        break;
                    case 'estadisticas':
                        await loadEstadisticasContent();
                        break;
                    case 'empresas':
                        await loadEmpresasContent();
                        break;
                    case 'herramientas':
                        await loadHerramientasContent();
                        break;
                    case 'inspecciones':
                        await loadInspeccionesContent();
                        break;
                    case 'reportes':
                        await loadReportesContent();
                        break;

                    case 'actividades':
                        await loadActividadesContent();
                        break;
                    case 'usuarios':
                        // Usuarios UI intentionally disabled. Show a friendly 'no disponible' message.
                        const contentArea = document.getElementById('content-area');
                        if (contentArea) {
                            contentArea.innerHTML = `
                                <div style="padding:2rem; text-align:center; color:var(--text-muted);">
                                    <h2>Gestión de Usuarios - No disponible</h2>
                                    <p>La gestión de usuarios se mantiene en la base de datos pero no está accesible desde esta interfaz.</p>
                                </div>
                            `;
                        }
                        break;
                    case 'usuario':
                        // Normalize activo like the header: if backend returns null but this is the logged-in user,
                        // infer active because they are using the app.
                        let uActivo = (typeof data.activo !== 'undefined') ? data.activo : null;
                        try {
                            const token = localStorage.getItem('token');
                            const storedRaw = localStorage.getItem('user');
                            const stored = storedRaw ? JSON.parse(storedRaw) : null;
                            const storedId = stored ? (stored.id || stored.ID || stored.Id) : null;
                            if ((uActivo === null || typeof uActivo === 'undefined') && token && storedId && String(storedId) === String(data.id)) {
                                uActivo = 1;
                            }
                        } catch (e) { }

                        content += `
                            <div class="detail-item">
                                <label>Nombre:</label>
                                <span>${data.nombre || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span>${data.email || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Rol:</label>
                                <span>${data.rol || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Estado:</label>
                                <span class="status-badge ${uActivo ? 'accepted' : 'rejected'}">${uActivo ? 'Activo' : 'Inactivo'}</span>
                            </div>
                        `;
                        break;

                    default:
                        await loadDashboardContent();
                }
            } catch (error) {
                console.error(`Error loading section ${section}:`, error);
                showToast('Error al cargar la sección', 'error', 'Error');
            }
        }

        // Cargar contenido del dashboard
        async function loadDashboardContent() {
            elements.contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Panel de Control</h1>
                    <p class="page-subtitle">Resumen general de inspecciones y herramientas</p>
                </div>

                <!-- Estadísticas -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon primary">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="empresas-trend">0%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="empresas-count">0</div>
                        <div class="stat-label">Empresas Clientes</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon warning">
                                <i class="fas fa-tools"></i>
                            </div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="herramientas-trend">0%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="herramientas-count">0</div>
                        <div class="stat-label">Herramientas Inspeccionadas</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon success">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="inspecciones-trend">0%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="inspecciones-count">0</div>
                        <div class="stat-label">Inspecciones Programadas</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon danger">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="trend down">
                                <i class="fas fa-arrow-down"></i>
                                <span id="reportes-trend">0%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="reportes-count">0</div>
                        <div class="stat-label">Reportes Generados</div>
                    </div>
                </div>

                // Contenido principal removido: el dashboard mostrará solo estadísticas
            `;

            // Cargar datos (estadísticas)
            await loadDashboardData();
        }

        // Cargar contenido de estadísticas
        async function loadEstadisticasContent() {
            elements.contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Estadísticas</h1>
                    <p class="page-subtitle">Métricas y análisis de datos</p>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Rango de fechas</label>
                        <select class="form-control" id="stats-date-range">
                            <option value="7">Últimos 7 días</option>
                            <option value="30" selected>Últimos 30 días</option>
                            <option value="90">Últimos 3 meses</option>
                            <option value="365">Último año</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tipo de estadística</label>
                        <select class="form-control" id="stats-type">
                            <option value="general" selected>General</option>
                            <option value="inspecciones">Inspecciones</option>
                            <option value="herramientas">Herramientas</option>
                            <option value="empresas">Empresas</option>
                        </select>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon primary">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="stats-empresas-trend">0%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="stats-empresas-count">0</div>
                        <div class="stat-label">Empresas Registradas</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon warning">
                                <i class="fas fa-tools"></i>
                            </div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="stats-herramientas-trend">0%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="stats-herramientas-count">0</div>
                        <div class="stat-label">Herramientas Registradas</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon success">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="stats-inspecciones-trend">0%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="stats-inspecciones-count">0</div>
                        <div class="stat-label">Inspecciones Realizadas</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon danger">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="stats-reportes-trend">0%</span>
                            </div>
                        </div>
                        <div class="stat-value" id="stats-reportes-count">0</div>
                        <div class="stat-label">Reportes Generados</div>
                    </div>
                </div>

                <div class="content-grid">
                    <!-- "Inspecciones por Estado" y "Distribución por Empresa" eliminados según solicitud. -->
                </div>
            `;

            async function loadEstadisticasData() {
                try {
                    // Obtén los valores de los filtros si existen
                    const range = document.getElementById('stats-date-range').value;
                    const type = document.getElementById('stats-type').value;

                    // Try Node API first, then fallback to PHP endpoint if needed
                    let stats = null;
                    try {
                        const response = await fetch(`${API_BASE_URL}/stats?range=${range}&type=${type}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        if (response.ok) {
                            const parsed = await response.json();
                            if (parsed && (typeof parsed.empresas !== 'undefined' || typeof parsed.herramientas !== 'undefined' || typeof parsed.inspecciones !== 'undefined' || typeof parsed.reportes !== 'undefined')) {
                                stats = parsed;
                            }
                        }
                    } catch (e) {
                        console.warn('Primary stats API failed, will try PHP fallback', e);
                    }

                    if (!stats) {
                        const fallbackBase = typeof APACHE_API_BASE !== 'undefined' ? APACHE_API_BASE : '';
                        const fallbackUrl = `${fallbackBase}/api/stats/get.php`;
                        try {
                            const fallbackResp = await fetch(fallbackUrl);
                            if (fallbackResp.ok) stats = await fallbackResp.json();
                        } catch (e) {
                            console.warn('PHP stats fallback failed', e);
                        }
                    }

                    stats = stats || {};

                    // Actualiza el HTML con los datos reales (soporta distintos nombres de campo)
                    document.getElementById('stats-empresas-count').textContent = (stats.empresas || stats.empresas_count || 0);
                    document.getElementById('stats-herramientas-count').textContent = (stats.herramientas || stats.herramientas_count || 0);
                    document.getElementById('stats-inspecciones-count').textContent = (stats.inspecciones || stats.inspecciones_count || 0);
                    document.getElementById('stats-reportes-count').textContent = (stats.reportes || stats.reportes_count || 0);

                    // Actualiza los "trend" (porcentaje de variación)
                    document.getElementById('stats-empresas-trend').textContent = stats.empresasTrend ? `${stats.empresasTrend}%` : '0%';
                    document.getElementById('stats-herramientas-trend').textContent = stats.herramientasTrend ? `${stats.herramientasTrend}%` : '0%';
                    document.getElementById('stats-inspecciones-trend').textContent = stats.inspeccionesTrend ? `${stats.inspeccionesTrend}%` : '0%';
                    document.getElementById('stats-reportes-trend').textContent = stats.reportesTrend ? `${stats.reportesTrend}%` : '0%';

                } catch (error) {
                    console.error('Error al cargar estadísticas:', error);
                    showToast('Error al cargar estadísticas', 'error', 'Error');
                }
            }

            // Ejecutar carga de datos de estadísticas después de renderizar la sección
            await loadEstadisticasData();

        }

        // Cargar contenido de empresas
        async function loadEmpresasContent() {
            elements.contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Gestión de Empresas</h1>
                    <p class="page-subtitle">Administrar empresas clientes</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Lista de Empresas</h2>
                        <div class="card-actions">
                            <button class="btn btn-primary" data-modal="empresas">
                                <i class="fas fa-plus"></i> Nueva Empresa
                            </button>
                        </div>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Buscar</label>
                            <input type="text" class="form-control" id="empresas-search" placeholder="Buscar empresa...">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Estado</label>
                            <select class="form-control" id="empresas-filter-status">
                                <option value="all">Todos</option>
                                <option value="active">Activas</option>
                                <option value="inactive">Inactivas</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Locación</th>
                                    <th>Taladro</th>
                                    <th>Ubicación</th>
                                    <th>OIT</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="empresas-list">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem;">
                                        <div class="loader"></div>
                                        <p class="text-small">Cargando empresas...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Event listeners
            document.getElementById('empresas-search').addEventListener('input', (e) => {
                state.filters.search = e.target.value;
                loadEmpresasList();
            });

            document.getElementById('empresas-filter-status').addEventListener('change', (e) => {
                state.filters.status = e.target.value;
                loadEmpresasList();
            });

            document.querySelector('[data-modal="empresas"]').addEventListener('click', () => openModal('empresas'));

            // Cargar lista de empresas
            await loadEmpresasList();
        }

        // Cargar contenido de herramientas
        async function loadHerramientasContent() {
            elements.contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Gestión de Herramientas</h1>
                    <p class="page-subtitle">Administrar herramientas inspeccionadas</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Lista de Herramientas</h2>
                        <div class="card-actions">
                            <button class="btn btn-primary" data-modal="herramientas">
                                <i class="fas fa-plus"></i> Nueva Herramienta
                            </button>
                        </div>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Buscar</label>
                            <input type="text" class="form-control" id="herramientas-search" placeholder="Buscar herramienta...">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Estado</label>
                            <select class="form-control" id="herramientas-filter-status">
                                <option value="all">Todos</option>
                                <option value="Aceptado">Aceptado</option>
                                <option value="No aceptado">No aceptado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Empresa</label>
                            <select class="form-control" id="herramientas-filter-empresa">
                                <option value="all">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Empresa</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Última Inspección</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="herramientas-list">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">
                                        <div class="loader"></div>
                                        <p class="text-small">Cargando herramientas...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Event listeners
            document.getElementById('herramientas-search').addEventListener('input', (e) => {
                state.filters.search = e.target.value;
                loadHerramientasList();
            });

            document.getElementById('herramientas-filter-status').addEventListener('change', (e) => {
                state.filters.status = e.target.value;
                loadHerramientasList();
            });

            document.getElementById('herramientas-filter-empresa').addEventListener('change', (e) => {
                state.filters.empresa = e.target.value;
                loadHerramientasList();
            });

            document.querySelector('[data-modal="herramientas"]').addEventListener('click', () => openModal('herramientas'));

            // Cargar lista de herramientas y empresas para el filtro
            await loadHerramientasList();
            await loadEmpresasForFilter();
        }

        // Cargar contenido de inspecciones
        async function loadInspeccionesContent() {
            elements.contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Gestión de Inspecciones</h1>
                    <p class="page-subtitle">Administrar inspecciones programadas</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Lista de Inspecciones</h2>
                        <div class="card-actions">
                            <button class="btn btn-primary" data-modal="inspecciones">
                                <i class="fas fa-plus"></i> Nueva Inspección
                            </button>
                        </div>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Buscar</label>
                            <input type="text" class="form-control" id="inspecciones-search" placeholder="Buscar inspección...">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Resultado</label>
                            <select class="form-control" id="inspecciones-filter-resultado">
                                <option value="all">Todos</option>
                                <option value="Aceptado">Aceptado</option>
                                <option value="No aceptado">No aceptado</option>
                                <option value="Pendiente">Pendiente</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Rango de fechas</label>
                            <input type="date" class="form-control" id="inspecciones-filter-fecha-desde">
                            <span>a</span>
                            <input type="date" class="form-control" id="inspecciones-filter-fecha-hasta">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>Herramienta</th>
                                    <th>Fecha</th>
                                    <th>Resultado</th>
                                    <th>Inspector</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inspecciones-list">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">
                                        <div class="loader"></div>
                                        <p class="text-small">Cargando inspecciones...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Event listeners
            document.getElementById('inspecciones-search').addEventListener('input', (e) => {
                state.filters.search = e.target.value;
                loadInspeccionesList();
            });

            document.getElementById('inspecciones-filter-resultado').addEventListener('change', (e) => {
                state.filters.resultado = e.target.value;
                loadInspeccionesList();
            });

            document.getElementById('inspecciones-filter-fecha-desde').addEventListener('change', (e) => {
                state.filters.fechaDesde = e.target.value;
                loadInspeccionesList();
            });

            document.getElementById('inspecciones-filter-fecha-hasta').addEventListener('change', (e) => {
                state.filters.fechaHasta = e.target.value;
                loadInspeccionesList();
            });

            document.querySelector('[data-modal="inspecciones"]').addEventListener('click', () => openModal('inspecciones'));

            // Cargar lista de inspecciones
            await loadInspeccionesList();
        }

        // Cargar contenido de actividades
        async function loadActividadesContent() {
            elements.contentArea.innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">Actividades</h1>
                        <p class="page-subtitle">Registrar actividades diarias realizadas</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Lista de Actividades</h2>
                            <div class="card-actions">
                                <button class="btn btn-primary" data-modal="actividades"><i class="fas fa-plus"></i> Nueva Actividad</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Empresa</th>
                                        <th>Descripción</th>
                                        <th>Fecha</th>
                                        <th>Usuario</th>
                                        <th>Avance</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="actividades-list">
                                    <tr>
                                        <td colspan="6" style="text-align:center; padding:2rem;"><div class="loader"></div><p class="text-small">Cargando actividades...</p></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

            document.querySelector('[data-modal="actividades"]').addEventListener('click', () => openModal('actividades'));
            await loadActividadesList();
        }

        // Cargar lista de actividades
        async function loadActividadesList() {
            try {
                // debug: resolve URL used for actividades
                const debugUrl = resolvePhpEndpoint('GET', '/actividades');
                console.log('DEBUG: fetching actividades from', debugUrl);
                let actividades = await apiGet('/actividades');
                // normalize shapes: array, wrapper { value: [...] }, or single object
                if (!actividades) actividades = [];
                else if (Array.isArray(actividades)) {
                    // ok
                } else if (actividades && Array.isArray(actividades.value)) {
                    actividades = actividades.value;
                } else if (typeof actividades === 'object') {
                    // single object -> wrap into array
                    actividades = [actividades];
                }
                const tbody = document.getElementById('actividades-list');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (!actividades || actividades.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--text-muted); padding:2rem">No hay actividades registradas</td></tr>`;
                    return;
                }

                actividades.forEach(a => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td>${a.tipo || 'N/A'}</td>
                            <td>${a.empresa_nombre || 'N/A'}</td>
                            <td>${(a.descripcion || '').slice(0, 80)}${(a.descripcion || '').length > 80 ? '...' : ''}</td>
                            <td>${formatDate(a.fecha)}</td>
                            <td>${a.usuario_nombre || 'N/A'}</td>
                            <td>${typeof a.avance !== 'undefined' ? a.avance + '%' : '0%'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" data-action="view" data-id="${a.id}" data-type="actividades"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-primary" data-action="edit" data-id="${a.id}" data-type="actividades"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" data-action="delete" data-id="${a.id}" data-type="actividades"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                    tbody.appendChild(tr);
                });

                tbody.querySelectorAll('[data-action="view"]').forEach(btn => btn.addEventListener('click', () => viewDetails(btn.dataset.type, btn.dataset.id)));
                tbody.querySelectorAll('[data-action="edit"]').forEach(btn => btn.addEventListener('click', () => openModal(btn.dataset.type, btn.dataset.id)));
                tbody.querySelectorAll('[data-action="delete"]').forEach(btn => btn.addEventListener('click', () => deleteItem(btn.dataset.type, btn.dataset.id)));
            } catch (error) {
                console.error('Error al cargar actividades:', error);
                // append debugging info to the UI
                const _tbody = document.getElementById('actividades-list');
                if (_tbody) _tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--danger); padding:2rem">Error al cargar las actividades: ${error.message || error}</td></tr>`;
            }
        }

        // Cargar contenido de reportes
        async function loadReportesContent() {
            elements.contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Gestión de Reportes</h1>
                    <p class="page-subtitle">Generar y administrar reportes</p>
                </div>

                <div class="content-grid">
                    <div class="content-column">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Reportes Generados</h2>
                                <div class="card-actions">
                                    <button class="btn btn-primary" data-modal="reportes">
                                        <i class="fas fa-plus"></i> Generar Reporte
                                    </button>
                                </div>
                            </div>
                            <div class="filters">
                                <div class="filter-group">
                                    <label class="filter-label">Buscar</label>
                                    <input type="text" class="form-control" id="reportes-search" placeholder="Buscar reporte...">
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Tipo</label>
                                    <select class="form-control" id="reportes-filter-tipo">
                                        <option value="all">Todos</option>
                                        <option value="inspecciones">Inspecciones</option>
                                        <option value="herramientas">Herramientas</option>
                                        <option value="empresas">Empresas</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Tipo</th>
                                            <th>Fecha de Generación</th>
                                            <th>Generado por</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportes-list">
                                        <tr>
                                            <td colspan="5" style="text-align: center; padding: 2rem;">
                                                <div class="loader"></div>
                                                <p class="text-small">Cargando reportes...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Quick-report UI removed as requested -->
                </div>
            `;

            // Event listeners
            document.getElementById('reportes-search').addEventListener('input', (e) => {
                state.filters.search = e.target.value;
                loadReportesList();
            });

            document.getElementById('reportes-filter-tipo').addEventListener('change', (e) => {
                state.filters.tipo = e.target.value;
                loadReportesList();
            });

            document.querySelector('[data-modal="reportes"]').addEventListener('click', () => openModal('reportes'));
            // Quick report UI removed; no event listener attached.

            // Cargar lista de reportes
            await loadReportesList();
        }

        // Cargar contenido de usuarios
        async function loadUsuariosContent() {
            elements.contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Gestión de Usuarios</h1>
                    <p class="page-subtitle">Administrar usuarios del sistema</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Lista de Usuarios</h2>
                        <div class="card-actions">
                            <!-- Usuarios UI controls disabled/hidden -->
                            <button class="btn btn-secondary btn-sm" id="refresh-usuarios" style="display:none"><i class="fas fa-refresh"></i> Actualizar</button>
                            <button class="btn btn-primary" disabled title="Gestión de usuarios deshabilitada en la interfaz">
                                <i class="fas fa-plus"></i> Nuevo Usuario
                            </button>
                        </div>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Buscar</label>
                            <input type="text" class="form-control" id="usuarios-search" placeholder="Buscar usuario...">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Rol</label>
                            <select class="form-control" id="usuarios-filter-rol">
                                <option value="all">Todos</option>
                                <option value="admin">Administrador</option>
                                <option value="inspector">Inspector</option>
                                <option value="usuario">Usuario</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Estado</label>
                            <select class="form-control" id="usuarios-filter-estado">
                                <option value="all">Todos</option>
                                <option value="active">Activo</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Último Acceso</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usuarios-list">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">
                                        <div class="loader"></div>
                                        <p class="text-small">Cargando usuarios...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Event listeners
            document.getElementById('usuarios-search').addEventListener('input', (e) => {
                state.filters.search = e.target.value;
                loadUsuariosList();
            });

            document.getElementById('usuarios-filter-rol').addEventListener('change', (e) => {
                state.filters.rol = e.target.value;
                loadUsuariosList();
            });

            document.getElementById('usuarios-filter-estado').addEventListener('change', (e) => {
                state.filters.estado = e.target.value;
                loadUsuariosList();
            });

            // Usuarios modal disabled: do not attach event listener
            // Usuarios modal trigger intentionally not used (UI disabled)

            // Attach refresh button
            const refreshBtn = document.getElementById('refresh-usuarios');
            if (refreshBtn) refreshBtn.addEventListener('click', () => loadUsuariosList());

            // Cargar lista de usuarios
            await loadUsuariosList();
        }

        // Cargar datos de estadísticas
        async function loadDashboardData() {
            try {
                showToast('Cargando datos...', 'info', 'Cargando');

                // Prefer the Apache/PHP stats endpoint (co-located with frontend & DB) to avoid cross-service inconsistencies.
                // If PHP fails, fall back to Node API.
                let dashboardStats = null;
                const cacheBuster = `cb=${Date.now()}`;
                const phpBase = typeof APACHE_API_BASE !== 'undefined' ? APACHE_API_BASE : '';
                const phpUrl = `${phpBase}/stats/get.php?${cacheBuster}`;
                try {
                    const phpResp = await fetch(phpUrl, { headers: { 'Content-Type': 'application/json' } });
                    if (phpResp.ok) dashboardStats = await phpResp.json();
                } catch (e) {
                    console.warn('PHP stats primary attempt failed, will try Node API', e);
                }

                if (!stats) {
                    try {
                        const statsResponse = await fetch(`${API_BASE_URL}/stats?${cacheBuster}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        if (statsResponse.ok) {
                            const parsed = await statsResponse.json();
                            if (parsed) dashboardStats = parsed;
                        }
                    } catch (e) {
                        console.warn('Node stats fallback failed', e);
                    }
                }
                // Ensure we have a stats object (result of PHP or Node attempts above)
                dashboardStats = dashboardStats || {};

                document.getElementById('stats-empresas-count').textContent = (dashboardStats.empresas || dashboardStats.empresas_count || 0);
                document.getElementById('stats-herramientas-count').textContent = (dashboardStats.herramientas || dashboardStats.herramientas_count || 0);
                document.getElementById('stats-inspecciones-count').textContent = (dashboardStats.inspecciones || dashboardStats.inspecciones_count || 0);
                document.getElementById('stats-reportes-count').textContent = (dashboardStats.reportes || dashboardStats.reportes_count || 0);

                // loadEmpresasList moved to top-level (defined at file end)

                // Añadir event listeners a los botones
                tbody.querySelectorAll('[data-action="view"]').forEach(btn => {
                    btn.addEventListener('click', () => viewDetails(btn.dataset.type, btn.dataset.id));
                });

                tbody.querySelectorAll('[data-action="edit"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const map = { empresa: 'empresas', herramienta: 'herramientas', inspeccion: 'inspecciones', reporte: 'reportes' };
                        const plural = map[btn.dataset.type] || (btn.dataset.type && btn.dataset.type.endsWith('s') ? btn.dataset.type : `${btn.dataset.type}s`);
                        openModal(plural, btn.dataset.id);
                    });
                });

                tbody.querySelectorAll('[data-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => deleteItem(btn.dataset.type, btn.dataset.id));
                });
                // Generar reporte desde empresa
                tbody.querySelectorAll('[data-action="generar-reporte"]').forEach(btn => {
                    btn.addEventListener('click', () => openReporteModalForEmpresa(btn.dataset.id));
                });
                // Botones para mostrar/ocultar herramientas por empresa
                tbody.querySelectorAll('[data-action="toggle-herramientas"]').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const empresaId = btn.dataset.id;
                        // encontrar la fila nested siguiente
                        const tr = btn.closest('tr');
                        const nested = tr.nextElementSibling;
                        if (!nested) return;

                        // Use computed style to reliably detect visibility
                        const isHidden = window.getComputedStyle(nested).display === 'none';
                        if (isHidden) {
                            // mostrar y cargar herramientas
                            nested.style.display = '';
                            btn.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up');
                            await loadHerramientasForEmpresa(empresaId);
                        } else {
                            // ocultar y limpiar contenido desplegado para que al reabrir se recargue
                            nested.style.display = 'none';
                            btn.querySelector('i').classList.replace('fa-chevron-up', 'fa-chevron-down');
                            const nestedContainer = nested.querySelector('.nested-tools');
                            if (nestedContainer) {
                                nestedContainer.innerHTML = `<div style="padding:1rem; color:var(--text-muted)">Cargando herramientas...</div>`;
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error al cargar empresas:', error);
                const tbody = document.getElementById('empresas-list');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: var(--danger)">
                                Error al cargar las empresas
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Cargar lista de herramientas
        async function loadHerramientasList() {
            try {
                const herramientas = await apiGet('/herramientas');
                const tbody = document.getElementById('herramientas-list');

                if (!tbody) return;

                tbody.innerHTML = '';

                if (herramientas.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted)">
                                No hay herramientas registradas
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Aplicar filtros
                let filteredHerramientas = herramientas;
                if (state.filters.search) {
                    const searchTerm = state.filters.search.toLowerCase();
                    filteredHerramientas = filteredHerramientas.filter(herramienta =>
                        herramienta.nombre.toLowerCase().includes(searchTerm) ||
                        (herramienta.empresa_nombre && herramienta.empresa_nombre.toLowerCase().includes(searchTerm)) ||
                        herramienta.tipo.toLowerCase().includes(searchTerm)
                    );
                }

                if (state.filters.status !== 'all') {
                    filteredHerramientas = filteredHerramientas.filter(herramienta => {
                        // ensure we compare against the normalized display value
                        const display = (herramienta.estadoDisplay || herramienta.estado || '').toString();
                        return display === state.filters.status;
                    });
                }

                if (state.filters.empresa && state.filters.empresa !== 'all') {
                    filteredHerramientas = filteredHerramientas.filter(herramienta =>
                        herramienta.empresa_id == state.filters.empresa
                    );
                }

                filteredHerramientas.forEach(herramienta => {
                    // normalize ultima inspeccion field name from backend (could be ultima_inspeccion or ultimaInspeccion)
                    herramienta.ultimaInspeccion = herramienta.ultimaInspeccion || herramienta.ultima_inspeccion || null;
                    // Normalize estado values to Spanish labels used in UI: 'Aceptado' or 'No aceptado'
                    let estadoRaw = herramienta.estado;
                    if (typeof estadoRaw === 'string') {
                        const v = estadoRaw.toLowerCase().trim();
                        if (v === 'accepted' || v === 'aceptado' || v === 'aprobado' || v === 'ok' || v === '1' || v === 'true') {
                            herramienta.estadoDisplay = 'Aceptado';
                        } else {
                            herramienta.estadoDisplay = 'No aceptado';
                        }
                    } else if (typeof estadoRaw === 'number') {
                        herramienta.estadoDisplay = estadoRaw === 1 ? 'Aceptado' : 'No aceptado';
                    } else if (typeof estadoRaw === 'boolean') {
                        herramienta.estadoDisplay = estadoRaw ? 'Aceptado' : 'No aceptado';
                    } else {
                        herramienta.estadoDisplay = 'No aceptado';
                    }
                    const row = document.createElement('tr');
                    const badgeClass = herramienta.estadoDisplay === 'Aceptado' ? 'accepted' : 'rejected';
                    row.innerHTML = `
                        <td>${herramienta.nombre || 'N/A'}</td>
                        <td>${herramienta.empresa_nombre || 'N/A'}</td>
                        <td>${herramienta.tipo || 'N/A'}</td>
                        <td><span class="status-badge ${badgeClass}">${herramienta.estadoDisplay}</span></td>
                        <td>${formatDate(herramienta.ultimaInspeccion) || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" data-action="view" data-id="${herramienta.id}" data-type="herramienta">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" data-action="edit" data-id="${herramienta.id}" data-type="herramienta">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" data-action="delete" data-id="${herramienta.id}" data-type="herramienta">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Añadir event listeners a los botones
                tbody.querySelectorAll('[data-action="view"]').forEach(btn => {
                    btn.addEventListener('click', () => viewDetails(btn.dataset.type, btn.dataset.id));
                });

                tbody.querySelectorAll('[data-action="edit"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const map = { empresa: 'empresas', herramienta: 'herramientas', inspeccion: 'inspecciones', reporte: 'reportes' };
                        const plural = map[btn.dataset.type] || (btn.dataset.type && btn.dataset.type.endsWith('s') ? btn.dataset.type : `${btn.dataset.type}s`);
                        openModal(plural, btn.dataset.id);
                    });
                });

                tbody.querySelectorAll('[data-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => deleteItem(btn.dataset.type, btn.dataset.id));
                });
            } catch (error) {
                console.error('Error al cargar herramientas:', error);
                const tbody = document.getElementById('herramientas-list');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--danger)">
                                Error al cargar las herramientas
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Cargar y renderizar herramientas para una empresa específica (fila anidada)
        async function loadHerramientasForEmpresa(empresaId) {
            try {
                const herramientas = await apiGet('/herramientas');
                const container = document.getElementById(`herramientas-for-empresa-${empresaId}`);
                if (!container) return;

                // indicador mientras carga
                container.innerHTML = `<div style="padding:1rem; color:var(--text-muted)">Cargando herramientas...</div>`;

                const items = (Array.isArray(herramientas) ? herramientas : []).filter(h => String(h.empresa_id) === String(empresaId));

                // header con botón agregar
                const headerHtml = `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:0.25rem 0 0.5rem 0">
                        <div style="font-weight:600">Herramientas</div>
                        <div><button class="btn btn-sm btn-primary" id="add-herramienta-for-${empresaId}"><i class="fas fa-plus"></i> Agregar herramienta</button></div>
                    </div>`;

                if (!items.length) {
                    container.innerHTML = headerHtml + `<div style="padding:1rem; color:var(--text-muted)">No hay herramientas para esta empresa.</div>`;
                    const addBtnEmpty = document.getElementById(`add-herramienta-for-${empresaId}`);
                    if (addBtnEmpty) addBtnEmpty.addEventListener('click', () => openHerramientaModalForEmpresa(empresaId));
                    return;
                }

                const listHtml = items.map(h => {
                    const ultima = h.ultimaInspeccion || h.ultima_inspeccion || null;
                    return `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom:1px solid var(--border-color)">
                            <div>
                                <div style="font-weight:600">${escapeHtml(h.nombre) || 'N/A'}</div>
                                <div style="font-size:0.85rem; color:var(--text-muted)">Tipo: ${escapeHtml(h.tipo) || 'N/A'} • Estado: ${escapeHtml(h.estado) || 'N/A'} • Últ. inspección: ${formatDate(ultima) || 'N/A'}</div>
                            </div>
                            <div style="display:flex; gap:0.5rem">
                                <button class="btn btn-sm btn-secondary" data-action="view-h" data-id="${h.id}"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-primary" data-action="edit-h" data-id="${h.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" data-action="delete-h" data-id="${h.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                }).join('');

                container.innerHTML = headerHtml + listHtml;

                // Attach add button
                const addBtn = document.getElementById(`add-herramienta-for-${empresaId}`);
                if (addBtn) addBtn.addEventListener('click', () => openHerramientaModalForEmpresa(empresaId));

                // Attach actions
                container.querySelectorAll('[data-action="view-h"]').forEach(btn => btn.addEventListener('click', () => viewDetails('herramienta', btn.dataset.id)));
                container.querySelectorAll('[data-action="edit-h"]').forEach(btn => btn.addEventListener('click', () => openModal('herramientas', btn.dataset.id)));
                container.querySelectorAll('[data-action="delete-h"]').forEach(btn => btn.addEventListener('click', async () => {
                    if (!confirm('¿Eliminar herramienta?')) return;
                    // remove item from DOM immediately
                    const item = btn.closest('.list-item');
                    if (item) item.remove();
                    // delegate to generic delete to handle API and refresh
                    await deleteItem('herramienta', btn.dataset.id);
                    // ensure nested list refreshed
                    await Promise.all([loadHerramientasList(), loadHerramientasForEmpresa(empresaId)]);
                }));
            } catch (error) {
                console.error('Error al cargar herramientas por empresa:', error);
                const container = document.getElementById(`herramientas-for-empresa-${empresaId}`);
                if (container) container.innerHTML = `<div style="padding:1rem; color:var(--danger)">Error al cargar las herramientas</div>`;
            }
        }

        // Abrir modal de crear herramienta con empresa preseleccionada
        async function openHerramientaModalForEmpresa(empresaId) {
            await openModal('herramientas');
            // después de renderizar el modal, fijar el select de empresa
            const sel = document.getElementById('herramienta-empresa');
            if (sel) {
                sel.value = String(empresaId);
            }
            const nombre = document.getElementById('herramienta-nombre');
            if (nombre) nombre.focus();
        }

        // Abrir modal de reportes con empresa preseleccionada
        async function openReporteModalForEmpresa(empresaId) {
            await openModal('reportes');
            const sel = document.getElementById('reporte-empresa');
            if (sel) sel.value = String(empresaId);
        }

        // simple escape helper for innerHTML
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str).replace(/[&<>"]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[s]));
        }

        // Cargar empresas para el filtro de herramientas
        async function loadEmpresasForFilter() {
            try {
                const empresas = await apiGet('/empresas');
                const select = document.getElementById('herramientas-filter-empresa');

                if (!select) return;

                // Limpiar opciones excepto la primera
                while (select.options.length > 1) {
                    select.remove(1);
                }

                // Añadir opciones de empresas
                empresas.forEach(empresa => {
                    const option = document.createElement('option');
                    option.value = empresa.id;
                    option.textContent = empresa.nombre;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar empresas para filtro:', error);
            }
        }

        // Cargar lista de inspecciones
        async function loadInspeccionesList() {
            try {
                const inspecciones = await apiGet('/inspecciones');
                const tbody = document.getElementById('inspecciones-list');

                if (!tbody) return;

                tbody.innerHTML = '';

                if (inspecciones.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted)">
                                No hay inspecciones registradas
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Aplicar filtros
                let filteredInspecciones = inspecciones;
                if (state.filters.search) {
                    const searchTerm = state.filters.search.toLowerCase();
                    filteredInspecciones = filteredInspecciones.filter(inspeccion =>
                        (inspeccion.empresa_nombre && inspeccion.empresa_nombre.toLowerCase().includes(searchTerm)) ||
                        (inspeccion.herramienta_nombre && inspeccion.herramienta_nombre.toLowerCase().includes(searchTerm)) ||
                        (inspeccion.inspector && inspeccion.inspector.toLowerCase().includes(searchTerm))
                    );
                }

                if (state.filters.resultado && state.filters.resultado !== 'all') {
                    filteredInspecciones = filteredInspecciones.filter(inspeccion =>
                        inspeccion.resultado === state.filters.resultado
                    );
                }

                if (state.filters.fechaDesde) {
                    filteredInspecciones = filteredInspecciones.filter(inspeccion =>
                        new Date(inspeccion.fecha) >= new Date(state.filters.fechaDesde)
                    );
                }

                if (state.filters.fechaHasta) {
                    filteredInspecciones = filteredInspecciones.filter(inspeccion =>
                        new Date(inspeccion.fecha) <= new Date(state.filters.fechaHasta)
                    );
                }

                filteredInspecciones.forEach(inspeccion => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${inspeccion.empresa_nombre || 'N/A'}</td>
                        <td>${inspeccion.herramienta_nombre || 'N/A'}</td>
                        <td>${formatDate(inspeccion.fecha)}</td>
                        <td><span class="status-badge ${inspeccion.resultado === 'Aceptado' ? 'accepted' : inspeccion.resultado === 'Pendiente' ? 'pending' : 'rejected'}">${inspeccion.resultado}</span></td>
                        <td>${inspeccion.inspector || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" data-action="view" data-id="${inspeccion.id}" data-type="inspeccion">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" data-action="edit" data-id="${inspeccion.id}" data-type="inspeccion">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" data-action="delete" data-id="${inspeccion.id}" data-type="inspeccion">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Añadir event listeners a los botones
                tbody.querySelectorAll('[data-action="view"]').forEach(btn => {
                    btn.addEventListener('click', () => viewDetails(btn.dataset.type, btn.dataset.id));
                });

                tbody.querySelectorAll('[data-action="edit"]').forEach(btn => {
                    btn.addEventListener('click', () => openModal(btn.dataset.type, btn.dataset.id));
                });

                tbody.querySelectorAll('[data-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => deleteItem(btn.dataset.type, btn.dataset.id));
                });
            } catch (error) {
                console.error('Error al cargar inspecciones:', error);
                const tbody = document.getElementById('inspecciones-list');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--danger)">
                                Error al cargar las inspecciones
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Cargar lista de reportes
        async function loadReportesList() {
            try {
                // Primary attempt: apiGet will try Node API then fall back to Apache when necessary
                let reportes = null;
                try {
                    reportes = await apiGet('/reportes');
                } catch (e) {
                    // apiGet may throw if Node endpoint 404s or CORS fails. Try explicit Apache PHP read.php fallback.
                    console.warn('apiGet(/reportes) failed, attempting explicit Apache fallback:', e);
                    try {
                        const fallbackUrl = `${APACHE_API_BASE}/reportes/read.php`;
                        const resp = await fetch(fallbackUrl, { method: 'GET' });
                        if (resp.ok) {
                            reportes = await resp.json();
                        } else {
                            // still not ok -> rethrow to outer catch
                            throw new Error(`Fallback returned ${resp.status}`);
                        }
                    } catch (fallbackErr) {
                        // propagate so outer catch handles UI message
                        throw fallbackErr;
                    }
                }
                const tbody = document.getElementById('reportes-list');
                // guard
                if (!tbody) return;

                tbody.innerHTML = '';

                if (!Array.isArray(reportes) || reportes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted)">
                                No hay reportes generados
                            </td>
                        </tr>
                    `;
                    // ensure counters reflect no reports
                    const rc = document.getElementById('reportes-count'); if (rc) rc.textContent = '0';
                    return;
                }

                // Aplicar filtros
                let filteredReportes = reportes;
                if (state.filters.search) {
                    const searchTerm = state.filters.search.toLowerCase();
                    filteredReportes = filteredReportes.filter(reporte =>
                        reporte.nombre.toLowerCase().includes(searchTerm) ||
                        (reporte.tipo && reporte.tipo.toLowerCase().includes(searchTerm)) ||
                        (reporte.usuario_nombre && reporte.usuario_nombre.toLowerCase().includes(searchTerm))
                    );
                }

                if (state.filters.tipo && state.filters.tipo !== 'all') {
                    filteredReportes = filteredReportes.filter(reporte =>
                        reporte.tipo === state.filters.tipo
                    );
                }

                filteredReportes.forEach(reporte => {
                    const row = document.createElement('tr');
                    // Add a direct Apache/PHP download link as a reliable fallback that opens in a new tab
                    const apacheDownloadHref = `${APACHE_API_BASE}/reportes/download.php?id=${reporte.id}`;
                    row.innerHTML = `
                        <td>${reporte.nombre || 'N/A'}</td>
                        <td>${reporte.tipo || 'N/A'}</td>
                        <td>${formatDate(reporte.fecha_generacion)}</td>
                        <td>${reporte.usuario_nombre || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" data-action="view" data-id="${reporte.id}" data-type="reporte">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" data-action="download" data-id="${reporte.id}" data-type="reporte">
                                <i class="fas fa-download"></i>
                            </button>
                            <!-- Direct link fallback: opens the PHP download endpoint in a new tab -->
                            <a class="btn btn-sm btn-outline-primary" href="${apacheDownloadHref}" target="_blank" rel="noopener" title="Abrir en nueva pestaña">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <button class="btn btn-sm btn-danger" data-action="delete" data-id="${reporte.id}" data-type="reporte">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Añadir event listeners a los botones
                tbody.querySelectorAll('[data-action="view"]').forEach(btn => {
                    btn.addEventListener('click', () => viewDetails(btn.dataset.type, btn.dataset.id));
                });

                tbody.querySelectorAll('[data-action="download"]').forEach(btn => {
                    btn.addEventListener('click', () => downloadReporte(btn.dataset.id));
                });

                // Descargar reporte (abrir/forzar descarga)
                async function downloadReporte(reporteId) {
                    const apacheFallback = `${APACHE_API_BASE}/reportes/download.php?id=${reporteId}`;
                    try {
                        // Primero intentar endpoint Node: /api/reportes/download/:id
                        let url = `${API_BASE_URL}/reportes/download/${reporteId}`;
                        let resp;
                        try {
                            resp = await fetch(url, { method: 'GET' });
                        } catch (fetchErr) {
                            // network error -> open apache fallback
                            console.warn('Node download fetch failed, opening Apache fallback', fetchErr);
                            window.open(apacheFallback, '_blank');
                            return;
                        }

                        if (resp.status === 404) {
                            // fallback a PHP en Apache
                            url = apacheFallback;
                            try {
                                resp = await fetch(url, { method: 'GET' });
                            } catch (phpFetchErr) {
                                console.warn('Apache download fetch failed, opening fallback URL in new tab', phpFetchErr);
                                window.open(apacheFallback, '_blank');
                                return;
                            }
                        }

                        if (!resp.ok) {
                            const text = await resp.text().catch(() => '');
                            console.error('Download error', resp.status, text);
                            // open fallback in case of server error
                            window.open(apacheFallback, '_blank');
                            showToast('Error al descargar el reporte: se abrirá en nueva pestaña', 'warning', 'Atención');
                            return;
                        }

                        // Si es un blob (PDF), forzar descarga
                        const contentType = resp.headers.get('Content-Type') || '';
                        if (contentType.includes('application/pdf') || contentType.includes('application/octet-stream')) {
                            const blob = await resp.blob();
                            const blobUrl = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = blobUrl;
                            a.download = `reporte_${reporteId}.pdf`;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            window.URL.revokeObjectURL(blobUrl);
                            showToast('Descarga iniciada', 'success', 'Éxito');
                            return;
                        }

                        // Si el servidor devolvió JSON con una URL, abrirla
                        const data = await resp.json().catch(() => null);
                        if (data && data.url) {
                            window.open(data.url, '_blank');
                            return;
                        }

                        // Último recurso: abrir la URL de Apache/PHP en nueva pestaña
                        window.open(apacheFallback, '_blank');
                    } catch (error) {
                        console.error('Error downloading reporte:', error);
                        // On unexpected errors, open fallback so user can still access file
                        window.open(apacheFallback, '_blank');
                        showToast('Error al descargar el reporte; abriendo en nueva pestaña', 'warning', 'Atención');
                    }
                }

                tbody.querySelectorAll('[data-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => deleteItem(btn.dataset.type, btn.dataset.id));
                });
            } catch (error) {
                console.error('Error al cargar reportes:', error);
                const tbody = document.getElementById('reportes-list');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: var(--danger)">
                                No se pudo cargar la lista de reportes (backend no disponible)
                            </td>
                        </tr>
                    `;
                }
                // set counts to zero for consistency
                const rc = document.getElementById('reportes-count'); if (rc) rc.textContent = '0';
            }
        }

        // Cargar lista de usuarios
        async function loadUsuariosList() {
            try {
                const resolvedUrlDebug = resolvePhpEndpoint('GET', '/usuarios');
                console.info('loadUsuariosList: resolved URL ->', resolvedUrlDebug);
                const usuarios = await apiGet('/usuarios');
                const tbody = document.getElementById('usuarios-list');

                if (!tbody) return;

                tbody.innerHTML = '';

                if (!usuarios || (Array.isArray(usuarios) && usuarios.length === 0)) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted)">
                                No hay usuarios registrados
                            </td>
                        </tr>
                    `;
                    return;
                }

                // If API returned an object with message, show it
                if (!Array.isArray(usuarios) && usuarios.message) {
                    tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--danger)">${usuarios.message}</td>
                            </tr>`;
                    return;
                }

                // Aplicar filtros
                let filteredUsuarios = usuarios;
                if (state.filters.search) {
                    const searchTerm = state.filters.search.toLowerCase();
                    filteredUsuarios = filteredUsuarios.filter(usuario =>
                        usuario.nombre.toLowerCase().includes(searchTerm) ||
                        usuario.email.toLowerCase().includes(searchTerm)
                    );
                }

                if (state.filters.rol && state.filters.rol !== 'all') {
                    filteredUsuarios = filteredUsuarios.filter(usuario =>
                        usuario.rol === state.filters.rol
                    );
                }

                if (state.filters.estado && state.filters.estado !== 'all') {
                    filteredUsuarios = filteredUsuarios.filter(usuario =>
                        state.filters.estado === 'active' ? usuario.activo : !usuario.activo
                    );
                }

                filteredUsuarios.forEach(usuario => {
                    // Compute displayActivo: prefer explicit value from backend; if null/undefined
                    // and this row is the logged-in user, infer active because they have a valid session.
                    let displayActivo = (typeof usuario.activo !== 'undefined' && usuario.activo !== null) ? usuario.activo : null;
                    try {
                        const token = localStorage.getItem('token');
                        const storedRaw = localStorage.getItem('user');
                        const stored = storedRaw ? JSON.parse(storedRaw) : null;
                        const storedId = stored ? (stored.id || stored.ID || stored.Id) : null;
                        if ((displayActivo === null || typeof displayActivo === 'undefined') && token && storedId && String(storedId) === String(usuario.id)) {
                            displayActivo = 1;
                        }
                    } catch (e) { /* ignore parse errors */ }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${usuario.nombre || 'N/A'}</td>
                        <td>${usuario.email || 'N/A'}</td>
                        <td>${usuario.rol || 'N/A'}</td>
                        <td><span class="status-badge ${displayActivo ? 'accepted' : 'rejected'}">${displayActivo ? 'Activo' : 'Inactivo'}</span></td>
                        <td>${formatDate(usuario.ultimo_acceso) || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" data-action="view" data-id="${usuario.id}" data-type="usuario">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" data-action="edit" data-id="${usuario.id}" data-type="usuario">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" data-action="delete" data-id="${usuario.id}" data-type="usuario">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Añadir event listeners a los botones
                tbody.querySelectorAll('[data-action="view"]').forEach(btn => {
                    btn.addEventListener('click', () => viewDetails(btn.dataset.type, btn.dataset.id));
                });

                tbody.querySelectorAll('[data-action="edit"]').forEach(btn => {
                    btn.addEventListener('click', () => openModal(btn.dataset.type, btn.dataset.id));
                });

                tbody.querySelectorAll('[data-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => deleteItem(btn.dataset.type, btn.dataset.id));
                });
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
                // If the error looks like a Node 404 (Cannot GET...), try direct Apache/PHP fallback for usuarios
                const msg = (error && error.message) ? error.message : String(error);
                if (msg.indexOf('Cannot GET') !== -1 || msg.indexOf('/api/usuarios') !== -1 || msg.indexOf('404') !== -1) {
                    try {
                        const fallbackUrl = `${APACHE_API_BASE}/usuarios/read.php`;
                        console.info('loadUsuariosList: attempting direct fallback ->', fallbackUrl);
                        const resp = await fetch(fallbackUrl);
                        console.info('loadUsuariosList: fallback response status', resp.status);
                        if (resp.ok) {
                            const text = await resp.text().catch(() => '');
                            let data = null;
                            try { data = JSON.parse(text); } catch (e) { data = null; }
                            if (Array.isArray(data)) {
                                // render users
                                const tbody = document.getElementById('usuarios-list');
                                tbody.innerHTML = '';
                                if (data.length === 0) {
                                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--text-muted); padding:2rem">No hay usuarios registrados</td></tr>`;
                                    return;
                                }
                                data.forEach(usuario => {
                                    // compute displayActivo as in main renderer
                                    let displayActivo = (typeof usuario.activo !== 'undefined' && usuario.activo !== null) ? usuario.activo : null;
                                    try {
                                        const token = localStorage.getItem('token');
                                        const storedRaw = localStorage.getItem('user');
                                        const stored = storedRaw ? JSON.parse(storedRaw) : null;
                                        const storedId = stored ? (stored.id || stored.ID || stored.Id) : null;
                                        if ((displayActivo === null || typeof displayActivo === 'undefined') && token && storedId && String(storedId) === String(usuario.id)) {
                                            displayActivo = 1;
                                        }
                                    } catch (e) { }

                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${usuario.nombre || 'N/A'}</td>
                                        <td>${usuario.email || 'N/A'}</td>
                                        <td>${usuario.rol || 'N/A'}</td>
                                        <td><span class="status-badge ${displayActivo ? 'accepted' : 'rejected'}">${displayActivo ? 'Activo' : 'Inactivo'}</span></td>
                                        <td>${formatDate(usuario.ultimo_acceso) || 'N/A'}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" data-action="view" data-id="${usuario.id}" data-type="usuario">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-primary" data-action="edit" data-id="${usuario.id}" data-type="usuario">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" data-action="delete" data-id="${usuario.id}" data-type="usuario">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    `;
                                    tbody.appendChild(row);
                                });
                                // attach listeners
                                tbody.querySelectorAll('[data-action="view"]').forEach(btn => btn.addEventListener('click', () => viewDetails(btn.dataset.type, btn.dataset.id)));
                                tbody.querySelectorAll('[data-action="edit"]').forEach(btn => btn.addEventListener('click', () => openModal(btn.dataset.type, btn.dataset.id)));
                                tbody.querySelectorAll('[data-action="delete"]').forEach(btn => btn.addEventListener('click', () => deleteItem(btn.dataset.type, btn.dataset.id)));
                                return;
                            } else {
                                // Show the raw response for debugging
                                const tbody = document.getElementById('usuarios-list');
                                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--warning); padding:2rem">Respuesta inesperada del servidor: <pre style="white-space:pre-wrap; text-align:left;">${escapeHtml(text)}</pre></td></tr>`;
                                return;
                            }
                        }
                    } catch (fallbackErr) {
                        console.warn('Direct fallback failed:', fallbackErr);
                    }
                }

                showToast(`Error cargando usuarios: ${msg}`, 'error', 'Error');
                const tbody = document.getElementById('usuarios-list');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--danger)">
                                Error al cargar los usuarios
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Recent items removed from dashboard; functions removed to avoid unused code

        // Abrir modal
        async function openModal(type, id = null) {
            state.currentModal = { type, id };

            elements.modalTitle.textContent = getModalTitle(type, id);
            elements.modalBody.innerHTML = await getModalContent(type, id);
            elements.modalOverlay.classList.add('active');

            // Configurar eventos específicos para cada modal
            setupModalEvents(type, id);
        }

        // Cerrar modal
        function closeModal(type = null) {
            if (type === 'detail') {
                document.getElementById('detail-modal').classList.remove('active');
            } else {
                elements.modalOverlay.classList.remove('active');
            }
            state.currentModal = null;
        }

        // Confirmar cierre de sesión: limpiar localStorage y redirigir
        // Logout handlers removed

        // Obtener título del modal según el tipo
        function getModalTitle(type, id = null) {
            const titles = {
                empresas: id ? 'Editar Empresa' : 'Crear Empresa',
                herramientas: id ? 'Editar Herramienta' : 'Crear Herramienta',
                inspecciones: id ? 'Editar Inspección' : 'Crear Inspección',
                reportes: 'Generar Reporte',
                actividades: id ? 'Editar Actividad' : 'Crear Actividad',
                usuarios: id ? 'Editar Usuario' : 'Crear Usuario',
                logout: 'Cerrar Sesión'
            };
            return titles[type] || 'Gestión';
        }

        // Obtener contenido del modal según el tipo
        async function getModalContent(type, id = null) {
            let content = '';
            let data = null;

            if (id) {
                // Cargar datos existentes para edición
                try {
                    data = await apiGet(`/${type}/${id}`);
                } catch (error) {
                    console.error(`Error loading ${type} data:`, error);
                    showToast(`Error al cargar los datos de ${type}`, 'error', 'Error');
                }
            }

            switch (type) {
                case 'empresas':
                    content = `
                        <div class="form-group">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="empresa-nombre" value="${data ? data.nombre : ''}" placeholder="Ingrese el nombre de la empresa" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Locación</label>
                            <input type="text" class="form-control" id="empresa-locacion" value="${data ? data.locacion : ''}" placeholder="Ingrese la locación">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Taladro</label>
                            <input type="text" class="form-control" id="empresa-taladro" value="${data ? data.taladro : ''}" placeholder="Ingrese el taladro">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ubicación</label>
                            <input type="text" class="form-control" id="empresa-ubicacion" value="${data ? data.ubicacion : ''}" placeholder="Ingrese la ubicación">
                        </div>
                        <div class="form-group">
                            <label class="form-label">OIT</label>
                            <input type="text" class="form-control" id="empresa-oit" value="${data ? data.oit : ''}" placeholder="Ingrese el OIT">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-control" id="empresa-activo">
                                <option value="true" ${data && data.activo ? 'selected' : ''}>Activa</option>
                                <option value="false" ${data && !data.activo ? 'selected' : ''}>Inactiva</option>
                            </select>
                        </div>
                    `;
                    break;

                case 'herramientas':
                    // Cargar empresas para el selector
                    const empresas = await apiGet('/empresas');
                    const empresasOptions = empresas.map(empresa =>
                        `<option value="${empresa.id}" ${data && data.empresa_id == empresa.id ? 'selected' : ''}>${empresa.nombre}</option>`
                    ).join('');

                    content = `
                        <div class="form-group">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="herramienta-nombre" value="${data ? data.nombre : ''}" placeholder="Ingrese el nombre de la herramienta" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Empresa *</label>
                            <select class="form-control" id="herramienta-empresa" required>
                                <option value="">Seleccione una empresa</option>
                                ${empresasOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo</label>
                            <input type="text" class="form-control" id="herramienta-tipo" value="${data ? data.tipo : ''}" placeholder="Ingrese el tipo de herramienta">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado *</label>
                            <select class="form-control" id="herramienta-estado" required>
                                <option value="Aceptado" ${data && data.estado === 'Aceptado' ? 'selected' : ''}>Aceptado</option>
                                <option value="No aceptado" ${data && data.estado === 'No aceptado' ? 'selected' : ''}>No aceptado</option>
                                <option value="Pendiente" ${data && data.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Última Inspección</label>
                            <input type="date" class="form-control" id="herramienta-ultima-inspeccion" value="${data ? data.ultimaInspeccion : ''}">
                        </div>
                    `;
                    break;

                case 'inspecciones':
                    // Cargar empresas y herramientas para los selectores
                    const empresasInsp = await apiGet('/empresas');
                    const herramientasInsp = await apiGet('/herramientas');

                    const empresasOptionsInsp = empresasInsp.map(empresa =>
                        `<option value="${empresa.id}" ${data && data.empresa_id == empresa.id ? 'selected' : ''}>${empresa.nombre}</option>`
                    ).join('');

                    const herramientasOptionsInsp = herramientasInsp.map(herramienta =>
                        `<option value="${herramienta.id}" ${data && data.herramienta_id == herramienta.id ? 'selected' : ''}>${herramienta.nombre}</option>`
                    ).join('');

                    content = `
                        <div class="form-group">
                            <label class="form-label">Empresa *</label>
                            <select class="form-control" id="inspeccion-empresa" required>
                                <option value="">Seleccione una empresa</option>
                                ${empresasOptionsInsp}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Herramienta *</label>
                            <select class="form-control" id="inspeccion-herramienta" required>
                                <option value="">Seleccione una herramienta</option>
                                ${herramientasOptionsInsp}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha *</label>
                            <input type="date" class="form-control" id="inspeccion-fecha" value="${data ? data.fecha : new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Resultado *</label>
                            <select class="form-control" id="inspeccion-resultado" required>
                                <option value="Aceptado" ${data && data.resultado === 'Aceptado' ? 'selected' : ''}>Aceptado</option>
                                <option value="No aceptado" ${data && data.resultado === 'No aceptado' ? 'selected' : ''}>No aceptado</option>
                                <option value="Pendiente" ${data && data.resultado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Inspector *</label>
                            <input type="text" class="form-control" id="inspeccion-inspector" value="${data ? data.inspector : state.user.nombre}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" id="inspeccion-observaciones" rows="3">${data ? data.observaciones : ''}</textarea>
                        </div>
                    `;
                    break;

                case 'actividades':
                    // cargar empresas para asociación opcional
                    const empresasAct = await apiGet('/empresas');
                    const empresasOptionsAct = empresasAct.map(e => `<option value="${e.id}" ${data && data.empresa_id == e.id ? 'selected' : ''}>${e.nombre}</option>`).join('');

                    content = `
                        <div class="form-group">
                            <label class="form-label">Tipo *</label>
                            <select class="form-control" id="actividad-tipo" required>
                                <option value="mantenimiento" ${data && data.tipo === 'mantenimiento' ? 'selected' : ''}>Mantenimiento</option>
                                <option value="inspección" ${data && data.tipo === 'inspección' ? 'selected' : ''}>Inspección</option>
                                <option value="operación" ${data && data.tipo === 'operación' ? 'selected' : ''}>Operación</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Empresa</label>
                            <select class="form-control" id="actividad-empresa">
                                <option value="">-- N/A --</option>
                                ${empresasOptionsAct}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descripción *</label>
                            <textarea class="form-control" id="actividad-descripcion" rows="3">${data ? (data.descripcion || '') : ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha</label>
                            <input type="datetime-local" class="form-control" id="actividad-fecha" value="${data ? (data.fecha ? new Date(data.fecha).toISOString().slice(0, 16) : '') : new Date().toISOString().slice(0, 16)}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Avance (%)</label>
                            <input type="number" class="form-control" id="actividad-avance" min="0" max="100" value="${data ? (typeof data.avance !== 'undefined' ? data.avance : 0) : 0}">
                        </div>
                    `;
                    break;

                case 'reportes':
                    // Cargar empresas para el selector
                    const empresasReporte = await apiGet('/empresas');
                    const empresasOptionsReporte = empresasReporte.map(empresa =>
                        `<option value="${empresa.id}">${empresa.nombre}</option>`
                    ).join('');

                    content = `
                        <div class="form-group">
                            <label class="form-label">Nombre del Reporte *</label>
                            <input type="text" class="form-control" id="reporte-nombre" placeholder="Ingrese el nombre del reporte" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Reporte *</label>
                            <select class="form-control" id="reporte-tipo" required>
                                <option value="inspecciones">Inspecciones</option>
                                <option value="herramientas">Herramientas</option>
                                <option value="empresas">Empresas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Formato *</label>
                            <select class="form-control" id="reporte-formato" required>
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Empresa</label>
                            <select class="form-control" id="reporte-empresa">
                                <option value="all">Todas las empresas</option>
                                ${empresasOptionsReporte}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rango de Fechas</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="date" class="form-control" id="reporte-fecha-desde">
                                <span style="line-height: 2.5;">a</span>
                                <input type="date" class="form-control" id="reporte-fecha-hasta">
                            </div>
                        </div>
                    `;
                    break;

                case 'usuarios':
                    content = `
                        <div class="form-group">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="usuario-nombre" value="${data ? data.nombre : ''}" placeholder="Ingrese el nombre del usuario" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="usuario-email" value="${data ? data.email : ''}" placeholder="Ingrese el email del usuario" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rol *</label>
                            <select class="form-control" id="usuario-rol" required>
                                <option value="admin" ${data && data.rol === 'admin' ? 'selected' : ''}>Administrador</option>
                                <option value="inspector" ${data && data.rol === 'inspector' ? 'selected' : ''}>Inspector</option>
                                <option value="usuario" ${data && data.rol === 'usuario' ? 'selected' : ''}>Usuario</option>
                            </select>
                        </div>
                        ${!data ? `
                        <div class="form-group">
                            <label class="form-label">Contraseña *</label>
                            <input type="password" class="form-control" id="usuario-password" placeholder="Ingrese la contraseña" required>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-control" id="usuario-activo">
                                <option value="true" ${data && data.activo ? 'selected' : ''}>Activo</option>
                                <option value="false" ${data && !data.activo ? 'selected' : ''}>Inactivo</option>
                            </select>
                        </div>
                    `;
                    break;

                default:
                    content = `
                        <div class="form-group">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" placeholder="Ingrese el nombre">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" rows="3" placeholder="Ingrese la descripción"></textarea>
                        </div>
                    `;
            }

            return content;
        }

        // Configurar eventos específicos para cada modal
        function setupModalEvents(type, id) {
            // Limpiar eventos anteriores
            elements.modalConfirm.onclick = null;

            // Asignar nuevo evento según el tipo de modal
            elements.modalConfirm.onclick = () => handleModalConfirm(type, id);

        }

        // Manejar confirmación del modal
        async function handleModalConfirm(type, id) {
            try {
                let formData = {};

                // Recopilar datos según el tipo de modal
                switch (type) {
                    case 'empresas':
                        formData = {
                            nombre: document.getElementById('empresa-nombre').value,
                            locacion: document.getElementById('empresa-locacion').value,
                            taladro: document.getElementById('empresa-taladro').value,
                            ubicacion: document.getElementById('empresa-ubicacion').value,
                            oit: document.getElementById('empresa-oit').value,
                            activo: document.getElementById('empresa-activo').value === 'true'
                        };
                        break;

                    case 'herramientas':
                        // collect multiple selected types (if any)
                        const tipoSelect = document.getElementById('herramienta-tipo');
                        let tipos = [];
                        if (tipoSelect && tipoSelect.selectedOptions) {
                            tipos = Array.from(tipoSelect.selectedOptions).map(o => o.value);
                        }
                        formData = {
                            nombre: document.getElementById('herramienta-nombre').value,
                            empresa_id: document.getElementById('herramienta-empresa').value,
                            tipo: document.getElementById('herramienta-tipo').value,
                            estado: document.getElementById('herramienta-estado').value,
                            ultimaInspeccion: document.getElementById('herramienta-ultima-inspeccion').value
                        };
                        break;

                    case 'inspecciones':
                        formData = {
                            empresa_id: document.getElementById('inspeccion-empresa').value,
                            herramienta_id: document.getElementById('inspeccion-herramienta').value,
                            fecha: document.getElementById('inspeccion-fecha').value,
                            resultado: document.getElementById('inspeccion-resultado').value,
                            inspector: document.getElementById('inspeccion-inspector').value,
                            observaciones: document.getElementById('inspeccion-observaciones').value
                        };
                        break;

                    case 'actividades':
                        formData = {
                            tipo: document.getElementById('actividad-tipo').value,
                            empresa_id: document.getElementById('actividad-empresa').value || null,
                            descripcion: document.getElementById('actividad-descripcion').value,
                            fecha: document.getElementById('actividad-fecha').value,
                            avance: parseInt(document.getElementById('actividad-avance').value || 0, 10)
                        };
                        break;

                    case 'reportes':
                        formData = {
                            nombre: document.getElementById('reporte-nombre').value,
                            tipo: document.getElementById('reporte-tipo').value,
                            formato: document.getElementById('reporte-formato').value,
                            empresa_id: document.getElementById('reporte-empresa').value,
                            fecha_desde: document.getElementById('reporte-fecha-desde').value,
                            fecha_hasta: document.getElementById('reporte-fecha-hasta').value
                        };
                        break;

                    case 'usuarios':
                        formData = {
                            nombre: document.getElementById('usuario-nombre').value,
                            email: document.getElementById('usuario-email').value,
                            rol: document.getElementById('usuario-rol').value,
                            activo: document.getElementById('usuario-activo').value === 'true'
                        };

                        if (!id) {
                            formData.password = document.getElementById('usuario-password').value;
                        }
                        break;
                }

                // Validar datos requeridos por tipo
                if (type === 'herramientas' && (!formData.nombre || !formData.empresa_id)) {
                    showToast('Complete nombre y empresa para la herramienta', 'error', 'Error de validación');
                    return;
                }

                if (type === 'empresas' && !formData.nombre) {
                    showToast('El nombre de la empresa es obligatorio', 'error', 'Error de validación');
                    return;
                }

                if (type === 'inspecciones' && (!formData.empresa_id || !formData.herramienta_id || !formData.fecha || !formData.resultado)) {
                    showToast('Complete empresa, herramienta, fecha y resultado para la inspección', 'error', 'Error de validación');
                    return;
                }

                // Para actividades: validar sólo los campos obligatorios (tipo y descripción)
                if (type === 'actividades') {
                    if (!formData.tipo || !formData.descripcion) {
                        showToast('Complete tipo y descripción para la actividad', 'error', 'Error de validación');
                        return;
                    }
                }

                let result;
                if (id) {
                    // Editar elemento existente
                    result = await apiPut(`/${type}/${id}`, formData);
                    if (type === 'actividades') showToast('Actividad actualizada correctamente', 'success', 'Éxito');
                    else showToast(`${type.slice(0, -1)} actualizado correctamente`, 'success', 'Éxito');
                } else {
                    // Crear nuevo elemento
                    result = await apiPost(`/${type}`, formData);
                    if (type === 'actividades') showToast('Actividad creada correctamente', 'success', 'Éxito');
                    else showToast(`${type.slice(0, -1)} creado correctamente`, 'success', 'Éxito');
                }

                // Cerrar modal
                closeModal();

                // Si se creó/actualizó una inspección, refrescar listas relacionadas explicitamente
                if (type === 'inspecciones') {
                    // Recargar lista de inspecciones y herramientas para que se muestre la nueva inspección
                    await Promise.all([loadInspeccionesList(), loadHerramientasList()]);
                    // Si estamos en la sección de inspecciones, recargarla también
                    if (state.currentSection === 'inspecciones') await loadInspeccionesContent();
                } else if (type === 'actividades') {
                    // Recargar lista de actividades
                    await Promise.all([loadActividadesList()]);
                    if (state.currentSection === 'actividades') await loadActividadesContent();
                } else {
                    // Para los demás tipos, recargar la sección correspondiente
                    await loadSection(type === 'empresas' || type === 'herramientas' || type === 'inspecciones' || type === 'reportes' || type === 'usuarios' ? type : state.currentSection);
                }

            } catch (error) {
                console.error(`Error saving ${type}:`, error);
                showToast(`Error al guardar ${type}`, 'error', 'Error');
            }
        }

        // Eliminar elemento
        async function deleteItem(type, id) {
            // normalize incoming type to plural for API endpoint, and singular for messages
            const typeMap = {
                empresa: 'empresas', empresas: 'empresas',
                herramienta: 'herramientas', herramientas: 'herramientas',
                inspeccion: 'inspecciones', inspecciones: 'inspecciones',
                reporte: 'reportes', reportes: 'reportes',
                // usuarios mapping removed: usuarios UI disabled
            };
            const plural = typeMap[type] || type;
            const singular = (type && typeof type === 'string') ? (type.replace(/s$/, '')) : 'elemento';

            if (!confirm(`¿Estás seguro de que deseas eliminar este ${singular}?`)) return;

            try {
                await apiDelete(`/${plural}/${id}`);
                showToast(`${singular} eliminado correctamente`, 'success', 'Éxito');
                // Try to remove any matching DOM element immediately for snappy UX
                try {
                    // remove table row
                    const btns = document.querySelectorAll(`[data-id="${id}"]`);
                    btns.forEach(b => {
                        const tr = b.closest('tr');
                        if (tr) {
                            tr.remove();
                            return;
                        }
                        const item = b.closest('.list-item');
                        if (item) item.remove();
                    });
                } catch (e) { /* ignore DOM errors */ }

                // reload current section; where possible caller will refresh specific lists too
                await loadSection(state.currentSection);
            } catch (error) {
                console.error(`Error deleting ${plural}:`, error);
                // Attempt direct Apache/PHP fallback: POST to /FERDATA/api/<tipo>/delete.php with JSON body {id}
                try {
                    const fallbackUrl = `${APACHE_API_BASE}/${plural}/delete.php`;
                    const token = localStorage.getItem('token');
                    const resp = await fetch(fallbackUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ id })
                    });
                    if (!resp.ok) {
                        const txt = await resp.text().catch(() => '');
                        throw new Error(`Fallback error ${resp.status} ${txt}`);
                    }
                    // success via fallback
                    showToast(`${singular} eliminado (fallback)`, 'success', 'Éxito');
                    try {
                        const btns = document.querySelectorAll(`[data-id="${id}"]`);
                        btns.forEach(b => {
                            const tr = b.closest('tr');
                            if (tr) { tr.remove(); return; }
                            const item = b.closest('.list-item');
                            if (item) item.remove();
                        });
                    } catch (e) { /* ignore DOM errors */ }
                    await loadSection(state.currentSection);
                } catch (fallbackErr) {
                    console.error('Fallback delete error:', fallbackErr);
                    showToast(`Error al eliminar ${singular}`, 'error', 'Error');
                }
            }
        }

        // Ver detalles de un elemento
        async function viewDetails(type, id) {
            try {
                // normalize type to plural for endpoint
                const map = { empresa: 'empresas', herramienta: 'herramientas', inspeccion: 'inspecciones', reporte: 'reportes' };
                const plural = map[type] || (type.endsWith('s') ? type : `${type}s`);
                let data = await apiGet(`/${plural}/${id}`);
                // Normalize possible response shapes:
                // - direct object { ... }
                // - array [ { ... } ]
                // - wrapper { value: [ { ... } ], Count: n }
                if (Array.isArray(data) && data.length) {
                    data = data[0];
                } else if (data && Array.isArray(data.value) && data.value.length) {
                    data = data.value[0];
                }
                const modal = document.getElementById('detail-modal');
                const title = document.getElementById('detail-modal-title');
                const body = document.getElementById('detail-modal-body');

                title.textContent = `Detalles de ${type}`;

                // prefer normalized inspector name if backend provides it
                if (data) {
                    if (!data.inspector && data.inspector_nombre) data.inspector = data.inspector_nombre;
                }

                // Generar contenido según el tipo
                let content = '<div class="detail-container">';

                switch (type) {
                    case 'empresa':
                        content += `
                            <div class="detail-item">
                                <label>Nombre:</label>
                                <span>${data.nombre || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Locación:</label>
                                <span>${data.locacion || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Taladro:</label>
                                <span>${data.taladro || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Ubicación:</label>
                                <span>${data.ubicacion || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>OIT:</label>
                                <span>${data.oit || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Estado:</label>
                                <span class="status-badge ${data.activo ? 'accepted' : 'rejected'}">${data.activo ? 'Activa' : 'Inactiva'}</span>
                            </div>
                        `;
                        break;

                    case 'herramienta':
                        content += `
                            <div class="detail-item">
                                <label>Nombre:</label>
                                <span>${data.nombre || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Empresa:</label>
                                <span>${data.empresa_nombre || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Tipo:</label>
                                <span>${data.tipo || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Estado:</label>
                                <span class="status-badge ${data.estado === 'Aceptado' ? 'accepted' : data.estado === 'Pendiente' ? 'pending' : 'rejected'}">${data.estado}</span>
                            </div>
                            <div class="detail-item">
                                <label>Última Inspección:</label>
                                <span>${formatDate(data.ultimaInspeccion) || 'N/A'}</span>
                            </div>
                        `;
                        break;

                    case 'inspeccion':
                        content += `
                            <div class="detail-item">
                                <label>Empresa:</label>
                                <span>${data.empresa_nombre || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Herramienta:</label>
                                <span>${data.herramienta_nombre || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Fecha:</label>
                                <span>${data && data.fecha ? formatDate(data.fecha) : 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Resultado:</label>
                                <span class="status-badge ${data.resultado === 'Aceptado' ? 'accepted' : data.resultado === 'Pendiente' ? 'pending' : 'rejected'}">${data.resultado}</span>
                            </div>
                            <div class="detail-item">
                                <label>Inspector:</label>
                                <span>${(data && (data.inspector || data.inspector_nombre)) ? (data.inspector || data.inspector_nombre) : 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Observaciones:</label>
                                <span>${data.observaciones || 'Ninguna'}</span>
                            </div>
                        `;
                        break;

                    default:
                        for (const [key, value] of Object.entries(data)) {
                            if (value !== null && value !== undefined) {
                                content += `
                                    <div class="detail-item">
                                        <label>${key.replace(/_/g, ' ')}:</label>
                                        <span>${value}</span>
                                    </div>
                                `;
                            }
                        }
                }

                content += '</div>';
                body.innerHTML = content;

                // Mostrar modal
                modal.classList.add('active');
            } catch (error) {
                console.error(`Error viewing ${type} details:`, error);
                showToast(`Error al cargar detalles de ${type}`, 'error', 'Error');
            }
        }

        // Aplicar filtros
        function applyFilters() {
            // Implementar lógica de filtrado según la sección actual
            // Esto depende de cómo esté estructurada cada sección
            console.log('Aplicando filtros:', state.filters);
        }

        // Exportar inspecciones
        async function exportInspections() {
            try {
                showToast('Generando reporte...', 'info', 'Exportando');

                // En una implementación real, esto haría una llamada al backend
                // para generar y descargar un archivo PDF/Excel
                await new Promise(resolve => setTimeout(resolve, 1500));

                showToast('Reporte generado correctamente', 'success', 'Éxito');

                // Simular descarga
                const a = document.createElement('a');
                a.href = 'data:text/csv;charset=utf-8,Empresa,Herramienta,Fecha,Resultado,Inspector\n';
                a.download = `inspecciones-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error exporting inspections:', error);
                showToast('Error al generar el reporte', 'error', 'Error');
            }
        }

        // Quick report generation removed

        // Descargar reporte
        async function downloadReporte(id) {
            try {
                showToast('Descargando reporte...', 'info', 'Descargando');

                // En una implementación real, esto haría una llamada al backend
                await new Promise(resolve => setTimeout(resolve, 1000));

                showToast('Reporte descargado correctamente', 'success', 'Éxito');

                // Simular descarga
                const a = document.createElement('a');
                a.href = 'data:text/csv;charset=utf-8,Reporte,Generado\n';
                a.download = `reporte-${id}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading report:', error);
                showToast('Error al descargar el reporte', 'error', 'Error');
            }
        }

        // Funciones de API
        // Resolver endpoints hacia los scripts PHP en /api/<tipo>/*.php
        function resolvePhpEndpoint(method, endpoint) {
            // endpoint esperado: '/tipo' o '/tipo/id' y puede incluir query string
            // separar query string si existe
            const [pathPart, queryPart] = (endpoint || '').split('?');
            const cleanPath = pathPart.replace(/^\/+/, '');
            const parts = cleanPath.split('/').filter(Boolean);
            const tipo = parts[0] || '';
            const id = parts[1] || null;

            // If the app is being served from a non-default port (e.g. Node dev on :3000),
            // prefer calling the Node-style endpoints directly (no read.php) so we hit
            // routes like /api/actividades instead of /api/actividades/read.php which 404 on Node.
            try {
                const port = window.location.port;
                if (port && port !== '80') {
                    // return Node-style path
                    return `${API_BASE_URL}${endpoint}`;
                }
                // also detect explicit API_BASE_URL pointing to a Node port
                if (API_BASE_URL && API_BASE_URL.indexOf(':3000') !== -1) {
                    return `${API_BASE_URL}${endpoint}`;
                }
            } catch (e) { /* ignore and fall back to PHP-style paths */ }

            const base = `${API_BASE_URL}/${tipo}`;

            const appendQuery = (s) => queryPart ? `${s}${s.indexOf('?') === -1 ? '?' : '&'}${queryPart}` : s;

            if (method === 'GET') {
                // Prefer Node-style API endpoints as primary (e.g. /api/actividades or /api/actividades/4)
                // The apiGet wrapper will attempt Apache/PHP read.php fallbacks if the primary returns 404 or network fails.
                if (id) return `${API_BASE_URL}/${tipo}/${encodeURIComponent(id)}`;
                return `${API_BASE_URL}/${tipo}` + (queryPart ? `?${queryPart}` : '');
            }

            if (method === 'POST') {
                return `${base}/create.php`;
            }

            if (method === 'PUT') {
                return `${base}/update.php`;
            }

            if (method === 'DELETE') {
                // include id in the path for Node/Express routers which expect /delete/:id or /delete.php/:id
                if (id) return `${base}/delete.php/${encodeURIComponent(id)}`;
                return `${base}/delete.php`;
            }

            // Fallback
            return `${API_BASE_URL}${endpoint}`;
        }

        async function apiGet(endpoint) {
            const token = localStorage.getItem('token');
            const url = resolvePhpEndpoint('GET', endpoint);
            // If running on localhost, prefer Apache/PHP read.php for GET to avoid proxy/node 404s
            try {
                const hostname = window.location.hostname;
                const port = window.location.port;
                // Only attempt direct Apache PHP read.php when served on default HTTP port (80) or no port
                if ((hostname === 'localhost' || hostname === '127.0.0.1') && (!port || port === '80')) {
                    const tipo = endpoint.replace(/^\/+/, '').split('/')[0] || endpoint.replace(/^\/+/, '');
                    const phpRead = `${APACHE_API_BASE}/${tipo}/read.php`;
                    console.info('apiGet: on localhost (port 80), trying phpRead first ->', phpRead);
                    try {
                        const firstResp = await fetch(phpRead, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                        if (firstResp.ok) {
                            try { return await firstResp.json(); } catch (e) { return await firstResp.text(); }
                        }
                        console.warn('apiGet: phpRead initial attempt failed', phpRead, firstResp.status);
                    } catch (err) {
                        console.warn('apiGet: phpRead fetch error', err);
                    }
                }
            } catch (e) { /* ignore and continue to normal flow */ }
            let response;
            try {
                response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (fetchErr) {
                // network error on primary API - try Apache/PHP fallback
                try {
                    const fallbackUrl = url.replace(API_BASE_URL, APACHE_API_BASE);
                    const fallbackResp = await fetch(fallbackUrl, {
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                    });
                    if (!fallbackResp.ok) {
                        const errText = await fallbackResp.text().catch(() => '');
                        throw new Error(`API fallback error: ${fallbackResp.status} ${errText}`);
                    }
                    try { return await fallbackResp.json(); } catch (e) { return await fallbackResp.text(); }
                } catch (e) {
                    throw fetchErr;
                }
            }
            // If the primary server returns 404, try multiple Apache/PHP fallbacks
            if (response.status === 404) {
                const primaryText = await response.text().catch(() => '');
                console.warn('apiGet: primary returned 404, body:', primaryText);

                // Prepare explicit candidate fallback URLs for read.php
                const candidates = [];
                try {
                    const tipo = endpoint.replace(/^\/+/, '').split('/')[0] || endpoint.replace(/^\/+/, '');

                    // 1) Apache PHP explicit: /FERDATA/api/<tipo>/read.php
                    candidates.push(`${APACHE_API_BASE}/${tipo}/read.php`);

                    // 2) Project-derived API path (in case API_BASE_URL was computed differently): <origin><basePath>/api/<tipo>/read.php
                    try {
                        const path = window.location.pathname;
                        const marker = '/frontend';
                        const idx = path.indexOf(marker);
                        const basePath = idx !== -1 ? path.slice(0, idx) : path.replace(/\/[^\/]*$/, '');
                        const projectApi = `${window.location.origin}${basePath}/api`;
                        candidates.push(`${projectApi}/${tipo}/read.php`);
                    } catch (e) { /* ignore */ }

                    // 3) If original url already had /read.php, include it; otherwise try replacing API_BASE_URL safely
                    if (url.indexOf('read.php') !== -1) {
                        candidates.push(url);
                    } else {
                        try {
                            const safeReplace = url.replace(API_BASE_URL, APACHE_API_BASE);
                            if (safeReplace && safeReplace !== url) candidates.push(safeReplace);
                        } catch (e) { }
                    }
                } catch (e) { console.warn('apiGet fallback build error', e); }

                // De-duplicate and try
                const tried = Array.from(new Set(candidates));
                console.info('apiGet: trying explicit fallbacks:', tried);

                for (const fb of tried) {
                    try {
                        const fbResp = await fetch(fb, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                        if (!fbResp.ok) {
                            console.warn('apiGet: fallback failed', fb, fbResp.status);
                            continue;
                        }
                        try { return await fbResp.json(); } catch (e) { return await fbResp.text(); }
                    } catch (err) {
                        console.warn('apiGet: fallback fetch error', fb, err);
                        continue;
                    }
                }

                // none of the fallbacks succeeded — throw original 404 with body for user
                throw new Error(`API error: ${response.status} ${primaryText}`);
            }

            if (!response.ok) {
                const errText = await response.text().catch(() => '');
                throw new Error(`API error: ${response.status} ${errText}`);
            }

            // Try JSON, fallback to text
            try {
                return await response.json();
            } catch (e) {
                return await response.text();
            }
        }

        async function apiPost(endpoint, data) {
            const token = localStorage.getItem('token');
            const url = resolvePhpEndpoint('POST', endpoint);

            const body = data && typeof data === 'object' ? JSON.stringify(data) : null;
            let response;
            try {
                response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body
                });
            } catch (fetchErr) {
                // try Apache fallback on network error
                try {
                    const fallbackUrl = url.replace(API_BASE_URL, APACHE_API_BASE);
                    const fallbackResp = await fetch(fallbackUrl, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body
                    });
                    if (!fallbackResp.ok) {
                        const errText = await fallbackResp.text().catch(() => '');
                        throw new Error(`API fallback error: ${fallbackResp.status} ${errText}`);
                    }
                    try { return await fallbackResp.json(); } catch (e) { return await fallbackResp.text(); }
                } catch (e) {
                    throw fetchErr;
                }
            }

            // Retry against APACHE_API_BASE if 404
            if (response.status === 404) {
                try {
                    const fallbackUrl = url.replace(API_BASE_URL, APACHE_API_BASE);
                    const fallbackResp = await fetch(fallbackUrl, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body
                    });
                    if (!fallbackResp.ok) {
                        const errText = await fallbackResp.text().catch(() => '');
                        throw new Error(`API fallback error: ${fallbackResp.status} ${errText}`);
                    }
                    try { return await fallbackResp.json(); } catch (e) { return await fallbackResp.text(); }
                } catch (e) {
                    // continue to throw original error below
                }
            }

            if (!response.ok) {
                const errText = await response.text().catch(() => '');
                const msg = `API error: ${response.status} ${errText}`;
                console.error('apiPost failed:', msg, { url, data });
                throw new Error(msg);
            }

            try {
                return await response.json();
            } catch (e) {
                return await response.text();
            }
        }

        async function apiPut(endpoint, data) {
            const token = localStorage.getItem('token');
            const url = resolvePhpEndpoint('PUT', endpoint);

            // If endpoint includes id like '/tipo/id', attach id to data
            const parts = endpoint.replace(/^\/+/, '').split('/');
            if (parts[1]) data = Object.assign({}, data, { id: parts[1] });

            const body = data && typeof data === 'object' ? JSON.stringify(data) : null;

            // Use POST to call update.php (server reads php://input regardless of method)
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body
            });

            if (response.status === 404) {
                try {
                    const fallbackUrl = url.replace(API_BASE_URL, APACHE_API_BASE);
                    const fallbackResp = await fetch(fallbackUrl, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body
                    });
                    if (!fallbackResp.ok) {
                        const errText = await fallbackResp.text().catch(() => '');
                        throw new Error(`API fallback error: ${fallbackResp.status} ${errText}`);
                    }
                    try { return await fallbackResp.json(); } catch (e) { return await fallbackResp.text(); }
                } catch (e) { }
            }

            if (!response.ok) {
                const errText = await response.text().catch(() => '');
                throw new Error(`API error: ${response.status} ${errText}`);
            }

            try {
                return await response.json();
            } catch (e) {
                return await response.text();
            }
        }

        async function apiDelete(endpoint) {
            const token = localStorage.getItem('token');
            const url = resolvePhpEndpoint('DELETE', endpoint);

            const parts = endpoint.replace(/^\/+/, '').split('/');
            const payload = parts[1] ? { id: parts[1] } : {};

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.status === 404) {
                try {
                    const fallbackUrl = url.replace(API_BASE_URL, APACHE_API_BASE);
                    const fallbackResp = await fetch(fallbackUrl, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!fallbackResp.ok) {
                        const errText = await fallbackResp.text().catch(() => '');
                        throw new Error(`API fallback error: ${fallbackResp.status} ${errText}`);
                    }
                    try { return await fallbackResp.json(); } catch (e) { return await fallbackResp.text(); }
                } catch (e) { }
            }

            if (!response.ok) {
                const errText = await response.text().catch(() => '');
                throw new Error(`API error: ${response.status} ${errText}`);
            }

            try {
                return await response.json();
            } catch (e) {
                return await response.text();
            }
        }

        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        }

        // Mostrar notificación toast
        function showToast(message, type = 'info', title = '') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // Compact small-toasts for brief status messages
            try {
                const m = (message || '').toString().toLowerCase();
                const t = (title || '').toString().toLowerCase();
                const compactKeywords = ['cargando', 'datos carg', 'cargado correctamente', 'descargando', 'descarga iniciada'];
                const isCompact = compactKeywords.some(k => m.includes(k) || t.includes(k));
                if (isCompact) toast.className += ' compact';
            } catch (e) { /* ignore */ }

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            toast.innerHTML = `
                <i class="fas ${icons[type]} toast-icon"></i>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close">&times;</button>
            `;

            elements.toastContainer.appendChild(toast);

            // Configurar evento para cerrar
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.remove();
            });

            // Auto-eliminar después de 5 segundos
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }

        // Cerrar sesión
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login';
        }

        // Inicializar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <script>
        // Top-level helper: loadEmpresasList
        async function loadEmpresasList() {
            try {
                const empresas = await apiGet('/empresas');
                const tbody = document.getElementById('empresas-list');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (!Array.isArray(empresas) || empresas.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted)">
                            No hay empresas registradas
                        </td>
                    </tr>
                `;
                    const ec = document.getElementById('empresas-count'); if (ec) ec.textContent = '0';
                    return;
                }

                let filteredEmpresas = empresas;
                if (state.filters.search) {
                    const searchTerm = state.filters.search.toLowerCase();
                    filteredEmpresas = filteredEmpresas.filter(empresa =>
                        (empresa.nombre || '').toLowerCase().includes(searchTerm) ||
                        (empresa.locacion || '').toLowerCase().includes(searchTerm) ||
                        (empresa.taladro || '').toLowerCase().includes(searchTerm) ||
                        (empresa.ubicacion || '').toLowerCase().includes(searchTerm) ||
                        (empresa.oit || '').toLowerCase().includes(searchTerm)
                    );
                }

                if (state.filters.status && state.filters.status !== 'all') {
                    filteredEmpresas = filteredEmpresas.filter(empresa =>
                        state.filters.status === 'active' ? empresa.activo : !empresa.activo
                    );
                }

                filteredEmpresas.forEach(empresa => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${empresa.nombre || 'N/A'}</td>
                    <td>${empresa.locacion || 'N/A'}</td>
                    <td>${empresa.taladro || 'N/A'}</td>
                    <td>${empresa.ubicacion || 'N/A'}</td>
                    <td>${empresa.oit || 'N/A'}</td>
                    <td><span class="status-badge ${empresa.activo ? 'accepted' : 'rejected'}">${empresa.activo ? 'Activa' : 'Inactiva'}</span></td>
                    <td>
                        <div style="display:flex; gap:0.25rem; align-items:center;">
                            <button class="btn btn-sm btn-secondary" data-action="toggle-herramientas" data-id="${empresa.id}" title="Mostrar herramientas">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" data-action="view" data-id="${empresa.id}" data-type="empresa">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-info" data-action="generar-reporte" data-id="${empresa.id}" title="Generar reporte">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" data-action="edit" data-id="${empresa.id}" data-type="empresa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" data-action="delete" data-id="${empresa.id}" data-type="empresa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                    tbody.appendChild(row);

                    // nested row
                    const nested = document.createElement('tr');
                    nested.classList.add('nested-row');
                    nested.style.display = 'none';
                    nested.innerHTML = `
                    <td colspan="7" style="padding:0;">
                        <div class="nested-tools" id="herramientas-for-empresa-${empresa.id}" style="padding:0.5rem 1rem;">
                            <div style="padding:1rem; color:var(--text-muted)">Cargando herramientas...</div>
                        </div>
                    </td>
                `;
                    tbody.appendChild(nested);
                });

                // attach listeners
                tbody.querySelectorAll('[data-action="view"]').forEach(btn => btn.addEventListener('click', () => viewDetails(btn.dataset.type, btn.dataset.id)));
                tbody.querySelectorAll('[data-action="edit"]').forEach(btn => btn.addEventListener('click', () => openModal(btn.dataset.type + 's', btn.dataset.id)));
                tbody.querySelectorAll('[data-action="delete"]').forEach(btn => btn.addEventListener('click', () => deleteItem(btn.dataset.type, btn.dataset.id)));
                tbody.querySelectorAll('[data-action="generar-reporte"]').forEach(btn => btn.addEventListener('click', () => openReporteModalForEmpresa(btn.dataset.id)));
                tbody.querySelectorAll('[data-action="toggle-herramientas"]').forEach(btn => btn.addEventListener('click', async () => {
                    const empresaId = btn.dataset.id;
                    const tr = btn.closest('tr');
                    const nested = tr.nextElementSibling;
                    if (!nested) return;
                    const isHidden = window.getComputedStyle(nested).display === 'none';
                    if (isHidden) {
                        nested.style.display = '';
                        btn.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up');
                        await loadHerramientasForEmpresa(empresaId);
                    } else {
                        nested.style.display = 'none';
                        btn.querySelector('i').classList.replace('fa-chevron-up', 'fa-chevron-down');
                        const nestedContainer = nested.querySelector('.nested-tools');
                        if (nestedContainer) nestedContainer.innerHTML = `<div style="padding:1rem; color:var(--text-muted)">Cargando herramientas...</div>`;
                    }
                }));
            } catch (error) {
                console.error('Error al cargar empresas (global):', error);
                const tbody = document.getElementById('empresas-list');
                if (tbody) tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--danger); padding:2rem">Error al cargar las empresas</td></tr>`;
            }
        }
    </script>
</body>

</html>